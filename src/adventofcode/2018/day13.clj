(ns adventofcode.2018.day13
  (:require [clojure.string :as str]))

(set! *print-length* 100)

(def input "                                  /----------------------------\\                                                                                      \n  /-------------------------------+----------------------------+-----------------------\\                                                              \n  |                               |                            |                     /-+------------------------------------------------\\             \n  |               /---------------+----------------------------+---------------------+-+-\\             /---------\\                      |             \n  |  /------------+------------\\  |                            |                   /-+-+-+-------------+---------+----------------\\     |             \n  |  |            |            |  |                            |                   | | | |             |         |          /-----+---\\ |             \n  |  |        /---+------------+--+-------------------------\\  |/------------------+-+-+-+-----------\\ |         |          |     |   | |             \n  |  |        |   |        /---+--+-------------------------+--++------------------+-+-+-+-----------+-+---------+---\\      |  /--+---+-+------\\      \n  |  |        |   |        |/--+--+-------------------------+--++------\\           | | | |           | |         |   |      |  |  |   | |      |      \n  |  |        |   |        ||  |  |                         |  ||     /+-----------+-+-+-+-----------+-+---------+---+------+--+--+---+-+------+-\\    \n  |  | /------+---+--------++--+--+-------------------------+--++-----++-----------+-+-+\\|           | |         |   |      |  |  |   | |      | |    \n  |  | |      |   |        ||  |  |                    /----+--++-----++-----------+-+-+++-----------+-+---------+---+------+--+--+---+\\|      | |    \n  |  | |    /-+---+--------++--+--+--------------------+----+--++-<---++----------\\| | |||           | |/--------+---+-\\    |  |  |   |||      | |    \n  |  | |    | |  /+--------++--+--+--\\               /-+----+--++-----++----------++-+-+++-----------+-++--------+---+-+----+--+--+---+++-----\\| |    \n  |  | |    | |  ||       /++--+--+--+-----------\\   | |    |  ||     ||  /-------++-+-+++-----------+-++--------+---+-+--\\ |  |  |   |||     || |    \n  | /+-+----+-+--++-------+++--+--+--+-----------+---+-+----+--++-----++--+-------++-+-+++-----------+-++-------\\|   | |  | |  |  |   |||     || |    \n  | || |    | |  ||       |||/-+--+--+-----------+---+-+----+--++-----++--+-------++-+-+++\\          | ||       ||   | |  | |  |  |   |||     || |    \n  | || |    | |  ||       |||| |  |  |           |   | |    |  ||     ||  | /-----++-+-++++----------+\\||       ||   ^ | /+-+--+--+---+++-----++-+---\\\n  | || |    | |  ||       |||| |  |  |           |   | |    |  ||     ||  | |     || | ||||          ||||       ||   | | || |  |  |   |||     || |   |\n  | || |    | |  ||       |||| |  |  |           |   | |  /-+--++-----++--+-+-----++-+-++++---\\      ||||       ||   | | || |  |  |   |||     || |   |\n  | || |    | |  ||       |||| |  |  |           |   | |  | |  ||     ||  | |     || | ||||   |      ||||       ||   | | || |  |  |   |||     || |   |\n  | || |    | |  ||       |||| |  |/-+-----------+---+-+--+-+--++-----++--+-+-----++-+-++++---+------++++-------++---+-+-++-+--+--+---+++-\\   || |   |\n  \\-++-+----+-+--++-------++++-+--++-+-----------+---+-+--+-+--++-----++--+-+-----++-+-/|||   |      ||||       ||   | | || |  |  |   ||| |   || |   |\n    || |    | |  ||     /-++++-+--++-+-----------+---+-+--+-+--++-----++--+-+-----++-+--+++---+------++++-------++---+-+-++-+--+\\ |   ||| |   || |   |\n    || |    | |  || /---+-++++-+--++-+-----------+---+-+--+-+--++--\\  ||  | |     || |  |||   |      ||||       ||   | | || |  || |   ||| |   || |   |\n    || | /--+-+--++-+---+-++++-+--++-+-----------+---+-+--+-+--++--+--++--+-+-----++-+-\\|||   |      ||||       ||   | | || |  || |   ||| |   || |   |\n    || | |  | |  || |   | |||\\-+--++-+-----------+---+-+--+-+--++--+--++--+-+-----++-+-+++/   |      ||||       ||   | | || |  || |   ||| |   || |   |\n    || | |  | |  || |   | |||  |/-++-+---------\\ |   | |  | |  ||  |  ||  | |     || | |||    |      ||||       ||   | | || |  || |   ||^ |   || |   |\n  /-++-+-+--+-+--++-+---+-+++--++-++-+---------+-+---+-+--+-+--++--+--++--+-+-----++-+-+++----+-----\\||||       ||   | | || |  || |   ||| |   || |   |\n  | || | |  | \\--++-+---+-+++--++-++-+---------+-+---+-+--+-/  ||  |  ||  | |     || |/+++----+-----+++++-\\     ||   | | || |  || |   ||| |   || |   |\n  | || | |  |    || |   | |||  || || |         | |   | |  |    ||  |  ||  | |     || |||||    |     ||||| |     ||   | | || |  || |   ||| |   || |   |\n  | || | |  |    || |   | |||  || || |         | |   | |  |    ||  |/-++--+-+-----++-+++++----+-----+++++-+-----++---+\\| || |  || |   ||| |   || |   |\n  | || | |  |    || |   | |||  || || |         | |   | |/-+----++--++-++--+-+-----++-+++++----+-----+++++-+-----++---+++-++-+-\\|| |   ||| |   || |   |\n  | || | |  |    || |   | |\\+--++-++-+---------+-+---+-++-+----++--++-++--+-+-----++-+++++----+-----+++++-+-----++---/|| || | ||| |   ||| |   || |   |\n  | |\\-+-+--+----++-+---+-+-+--/| || |         | |   | || |  /-++--++-++--+-+-\\   || |||||    |     |||\\+-+-----+/    || || | ||| |   ||| |   || |   |\n  | |  \\-+--+----++-+---+-+-+---+-++-+---------+-+---+-++-+--+-++--++-++--+-+-+---++-+++/|    |     ||| | |     |/----++-++-+-+++\\|   ||| |   || |   |\n  | |    |  | /--++-+---+-+\\|   | || |         | |   | || |  | ||  || ||  | | |   || \\++-+----+-----+++-+-+-----++----++-++-+-+++++---++/ |   || |   |\n/-+-+----+--+-+--++-+---+-+++--\\| \\+-+---------+-+---+-++-+--+-/|  || ||  | | |   ||  || |    |     ||| | |     ||    || || | |||||   ||  |   || |   |\n| | |    |  | |  || |   | |||  ||  | |         | |   | || |  |  |  || ||  | | |   ||  || |    |     ||| | |     ||    || || | |||||   ||  |   || |   |\n| | |    | /+-+--++-+---+-+++--++--+-+---------+-+---+-++-+--+-\\|  || ||  | | |/--++--++-+----+-----+++-+-+-----++----++-++-+\\|||||   ||  |   || |   |\n| | |    | || |  || |   | |||  ||  | |  /------+-+---+-++-+--+-++--++-++--+-+-++--++--++-+----+-----+++-+-+---\\ ||    || || |||||||   ||  |   || |   |\n| | |    | || |  || |   | |||  ||  | |  | /----+-+---+-++-+--+-++--++-++--+-+\\||  ||  || |    |     ||| \\-+---+-++----+/ || |||||||   ||  |   || |   |\n| | |   /+-++-+--++-+---+-+++--++--+-+--+-+----+-+---+-++-+--+-++--++-++--+-++++--++--++-+----+-----+++---+\\  |/++----+--++-+++++++--\\||  |   || |   |\n| | |   || || |  || |   | |||  ||  | |  | |    | |   | || |  | ||  || ||  | ||||  ||  || |    |     |||   ||  ||||    |  || |||||||  |||  |   || |   |\n| | |   || || |  || | /-+-+++--++--+-+--+-+----+-+---+-++-+--+-++--++-++--+\\|||| /++--++-+----+-----+++--\\||  ||||    |  || |||\\+++--+++--+---+/ |   |\n| | |   || || |  || | | | |||  ||  | |  | |    | |   | || \\--+-++--++-++--++++++-+++--++-+----/     |||  |||  ||||    |  || ||| |||  |||  |   |  |   |\n| | |   || |\\-+--++-+-+-+-+++--++--+-+--+-+----+-+---+-++----+-++--++-++--++++++-+/|  || |          |||  |||  ||||    |  || ||| |||  |||  |   |  |   |\n| | |   || |/-+--++-+-+-+-+++--++--+-+--+-+----+-+---+-++----+-++--++-++--++++++-+-+--++-+---\\      |||  |||  ||||    |  || ||| |||  |||  |   |  |   |\n| | |   || ||/+--++-+-+-+-+++--++--+-+\\ | |    | |/--+-++----+-++--++-++--++++++-+-+--++-+---+-\\    |||  |||  ||||    |  || ||| |||  |||  |   |  |   |\n| | |   || ||||  || | | | |||  ||  | || | |  /-+-++>-+-++----+-++--++-++--++++++-+-+--++-+---+-+----+++--+++--++++----+--++-+++-+++--+++--+---+\\ |   |\n| | | /-++-++++--++-+-+-+-+++--++--+\\|| | |  | | ||  | ||    | ||  || ||  |||||\\-+-+--++-+---+-+----+++--+++--++++----+--++-+/| |||  |||  |   || |   |\n| ^ | | || ||||  || | | | |||  ||  |||| | |  | | ||  | \\+----+-++--++-++--+++++--+-+--++-+---+-+----+++--+++--++++----+--++-+-+-+++--++/  |   || |   |\n| | | | ||/++++--++-+-+-+-+++--++--++++-+-+--+-+-++--+--+----+-++--++<++--+++++--+-+--++-+---+-+-\\  |||  |||  ||||    |  ||/+-+-+++--++---+--\\|| |   |\n| | | | |||||||  || | | | |||  ||  ||||/+-+--+-+-++--+--+----+-++--++-++--+++++--+-+--++-+--\\| | |  |||  |||  ||||    |  |||| | |||  ||   |  ||| |   |\n| | | | |||||||  || | | | |||  ||  |||||| |  | | ||  |  |    \\-++--++-++--++++/ /+-+--++-+--++-+-+--+++--+++--++++----+-\\|||| | |||  ||   |  ||| |   |\n| | | | |||||||  || | | | |||  ||  |||||| |  | | ||  | /+------++--++-++\\ \\+++--++-+--++-+--++-+-+--+++--+++--++++----+-++/|| | |||  ||   |  ||| |   |\n| | | | |||||||  || | | | |||  ||  |||||| |  | | ||  | ||/-----++--++-+++--+++--++-+--++-+--++-+-+--+++--+++--++++----+-++-++-+-+++--++---+--+++\\|   |\n| | | | |||\\+++--++-+-+-+-+++--++--++++++-+--+-+-++--+-+++-----/|  || |||  |||  || |  || |  || | |  |||  |||  ||||    | || || | |||  ||   |  |||||   |\n| | | | ||| |||  || | | | |||  ||  |||||| |/-+-+-++--+-+++------+--++-+++--+++--++-+--++-+--++-+-+--+++--+++--++++----+-++-++-+-+++\\ ||   |  |||||   |\n| | | | ||| |\\+--++-+-+-+-+++--++--+++/|| || | | ||  | |||      |  || |||  |||  || | /++-+--++\\| |  |||  |||  ||||    | || || | |||| ||   |  |||||   |\n| | | | ||| | |  || | | | |||  ||  ||| || || | | ||  | |||      |  || |||  |||  || | ||| |  ||||/+--+++--+++--++++--\\ | || || | |||| ||   |  |||||   |\n| | | | ||| |/+--++-+-+-+-+++--++\\ ||| || || | | ||  | |||      |  || |||  |||  || | ||| |  ||||||  |||  |||  ||||  | | || || | |||| ||   |  |||||   |\n| | | | ||| |||  || | | | |||  ||| ||| || ||/+-+-++--+\\|||      |  || |||  |||  || | ||| | /++++++--+++--+++--++++--+-+-++-++\\| |||| ||   |  |||||   |\n| | | | ||| |||  || | | \\-+++--+++-+++-++-++++-+-++--+++++------+--++-+++--+++--++-+-+++-+-+++++++--+++--+++--++++--+-+-++-++++-/||| ||   |  |||||   |\n| | | | ||| |||  || | |   |||  ||| ||| || \\+++-+-++--+++++------+--++-+++--++/  || | ||| | |||||||  |||  |||  ||||  | | || ||||  ||| ||   |  |||||   |\n| | v | |\\+-+++--++-+-+---+++--+++-+++-++--+++-+-++--+++++------+--++-+++--++---++-+-++/ | |||||||  |||  |||  ||||  | | || ||||  ||| ||   |  |||||   |\n| | | | | | |||  || | |   |||  ||| ||| ||  ||| | ||  |||\\+------+--++-+++--++---++-+-++--+-+++++++--+++--+++--++++--+-+-++-+++/  ||| ||   |  |||||   |\n| | | | | | |||  || |/+---+++--+++-+++-++--+++\\| ||  ||| |      |  || |||/>++---++-+-++--+-+++++++--+++--+++--++++--+-+-++-+++---+++-++--\\|  |||||   |\n| | | | | | |||  ||/+++---+++--+++-+++-++--+++++\\||  ||| |      |  || |||| ||/--++-+-++--+-+++++++--+++--+++-\\||||  | | || |||   ||| ||  ||  |||||   |\n| | | |/+-+-+++--++++++---+++--+++-+++-++--++++++++\\ ||| |      |  ||/++++-+++--++-+\\||  | |||||||  |||  ||| |||||  | | || |||   ||| ||  ||  |||||   |\n| | | \\++-+-+++--++++++---+++--+++-+/| ||  ||||||||| ||| |      |  ||||||| |||  || ||||  | |||||||/-+++--+++-+++++-\\| | || |||   ||| ||  ||  |||||   |\n| | |  || | |||  ||||||   |||  ||| | | ||  ||||||||| ||| |     /+--+++++++-+++--++-++++--+-++++++++-+++--+++-+++++-++-+-++-+++---+++-++--++--+++++\\  |\n| | |  || | |||  ||||||   |||  ||| \\-+-++--+++++++++-+++-+-----++--+++++++-+++--++-++++--+-++++++++-+++--+++-+++++-++-+-++-+++---+++-++--+/  ||||||  |\n| | |  || | |||  ||||||   |||  |||   | ||  ||||||||| ||| |     ||  ||||||| |||  || ||||  | |||||||| |||  ||| ||||| || | || |||   ||| ||  |   ||||||  |\n| | |  || | ||\\--++++++---+/| /+++---+-++--+++++++++-+++-+-----++--+++++++-+++--++-++++--+-++++++++-+++--+++-+++++-++-+-++-+++--\\||| ||  |   ||||||  |\n| \\-+--++-+-++---++++++---+-+-++++---+-++--+++++++++-+++-+-----++--+++++++-+++--++-++++--+-++++++++-/||  ||| ||||| || | || |||  |||| ||  |   ||||||  |\n|   |  || | ||   ||||||   | | ||||   | ||  ||||||||| ||| |     ||/-+++++++-+++\\ || ||||  | ||||||||  ||  ||| ||||| || | || |||  |||| ||  |   ||||||  |\n|   |  || | ||   ||||||   | | ||||   | ||  ||||||||| ||| |     ||| ||||||| |||| || ||||  | ||||||||  ||  ||| ||||| || | || |||  |||| ||  |   ||||||  |\n|   |  || | ||   ||||||   | | ||||   | ||  ||||||||| ||| |     ||| ||||||| |||| || \\+++--+-++++++++--++--+++-+++++-++-+-++-+++--++/| ||  |   ||||||  |\n|   |  || | ||   ||||||   | | ||||   | ||  ||||||||| ||| |     ||| ||||||| |||| ||  |||  | ||||||||  ||  ||| ||||| || | || |||  || | ||  |   ||||||  |\n|   |  || | ||   ||||||   | | ||||   | ||  ||||||||| ||| |     ||| ||||||| |||| ||  |||  | \\+++++++--++--+++-+++++-++-+-++-++/  || | ||  |   ||||||  |\n|   |  || | ||   ||||||   | | |||| /-+-++--+++++++++-+++-+-----+++-+++++++-++++-++--+++--+--+++++++--++\\ ||| ||||| || | || ||   || | ||  |   ||||||  |\n|   |  || | ||   ||||||   | | |||| | | ||  |\\+++++++-+/| \\-----+++-+++++++-++++-++--+++--+--+++++++--+++-+++-+++++-++-+-++-++---++-+-++--+---+++/||  |\n|   |  || | || /-++++++---+-+\\|||| | | || /+-+++++++-+-+\\      ||| |||\\+++-++++-++--+++--+--+++++++--+++-+++-+++++-++-+-++-++---++-+-++--+---+++-/|  |\n|   |/-++-+-++-+-++++++---+-++++++-+-+-++-++-+++++++-+\\||      ||| ||| ||v |||| ||  |||  |  |||||||  ||| ||| ||||| || | || ||   || | ||  |   |||  |  |\n|   || || | || | ||||||   | |||||| | | || || ||||||| ||||      ||| |\\+-+++-++++-++--+++--+--+++++++--+++-+++-+++++-++-/ ^| ||   || | ||  |   |||  |  |\n|   || || | || | ||||||   | ||||\\+-+-+-++-++-++/|||| ||||      ||| | | ||| ||\\+-++--+++--+--+++++++--+++-+++-/|||| ||   || ||   || | ||  |   |||  |  |\n|   || || | || | ||||||   | |||| | | | || || ||/++++-++++---\\  ||| | | ||| || | ||  |||  |  |||||||  ||| |||  |||\\-++---++-++---+/ | ||  |   |||  |  |\n|   || |\\-+-++-+-++++++---+-++++-+-+-+-++-++-+++++++-++++---+--+++-+-+-+++-++-+-++--+++--+--+++++++--+++-++/  |||  ||   || ||   |  | ||  |   |||  |  |\n|   || |  | || | ||||||   | |||| | | | || || ||||||| \\+++---+--+++-+-+-+++-++-+-++--+++--+--+++++++--+++-++---+++--++---++-++---+--+-++--+---+/|  |  |\n|   || |  | || | ||||||   \\-++++-+-+-+-++-++-++++/||  |||   |  ||| | | ||| || | ||  |||  |  |||||||  ||| ||   |||  ||   || ||   |  | ||  |   | |  |  |\n|   || |  | || | ||||||     |||| | | | || || |||| ||  |||   |  ||| | | ||| || | ||  |||  |  ||||\\++--+++-++---+++--+/   || ||   |  | ||  |   | |  |  |\n|   || |  | || | ||||||     |||| | | | || || |||| ||  |||   |  ||| | | ||| || | |\\--+++--+--++++-++--+++-/|   |||  |    || ||   |  | ||  |   | |  |  |\n|   || |  | || | ||||||     |||| | | | || || |||| ||  |||   |  ||| | |/+++-++-+\\|   |||  |  |||| ||  |||  |   |||  |    || ||   |  | ||  |   | |  v  |\n|   || |  \\-++-+-++++++-----++++-+-+-+-++-++-++++-++--+++---+--+++-+-+++++-++-+++---+++--+--++++-/|  |||  |   |||  |    |\\-++---+--+-++--+---+-+--+--/\n|   |\\-+----++-+-++++++-----++++-+-+-+-++-++-++++-++--/||   |  ||| | ||||| || |||   |||  |  ||||  |  |||  |   |||  |    |  ||   |  | ||  |   | |  |   \n|   |  | /--++-+-++++++-----++++-+-+-+-++-++-++++-++-\\ ||   |  ||| | \\++++-++-+++---/||  |  ||||  |  |||  |   |||  |    |  |\\---+--+-+/  |   | |  |   \n|   |  | |  || | ||||||/----++++-+-+-+-++\\|| |||| || | ||   |  \\++-+--++++-++-+++----++--+--++++--+--+++--+---+++--+----+--+----+--+-+---+---+-+--/   \n|   |  | |/-++-+-+++++++----++++-+-+-+-+++++-++++-++-+-++---+---++-+--++++-++-+++\\   ||  |  ||||  |  |||  |   |||  |    |  |    |  | |   |   | |      \n|   |  | ||/++-+-+++++++----++++-+-+-+-+++++\\|||| || | ||   |   || |  |||| || ||||   ||  |  ||||  |  |||  |   |||  |    |  |    |  | |   |   | |      \n|   |  | ||||| | \\++++++----++++-+-+-/ |||||||||| ||/+-++---+---++-+--++++-++-++++---++--+--++++--+-\\|||  |   |||  |    |  |    |  | |   |   | |      \n|   |  | ||||| \\--++++++----+/|| | |   \\+++++++++-++++-++---+---++-+--++++-++-++++---++--+--/|||  | ||||  |  /+++--+----+-\\|    |  | |   |   | |      \n|   \\--+-+++++----++++++----+-++-+-+----+++++++++-++++-++---+---++-+--++++-++-++++---++--+---+++--+-++++--+--+++/  |    |/++----+--+-+---+---+\\|      \n|      | |||||    ||||||    \\-++-+-+----+++++++++-++++-++---+---++-+--+/|| |\\-++++---++--+---+++--+-++/|  |  |||   |    ||||    |  | |   |   |||      \n|      | |||||    ||\\+++------++-+-+----+++++++++-++++-++---+---++-/  |/++-+--++++---++--+---+++--+-++-+--+--+++---+----++++----+--+-+-\\ |   |||      \n|     /+-+++++---\\|| |||      || | |    |||||||||/++++-++---+---++----++++-+--++++---++--+---+++--+-++-+--+--+++---+----++++-\\  |  | | | |   |||      \n|     || |||||   ||| |\\+------++-+-+----++++++++++++++-++---+---++----++++-/  ||||   ||  |   |||  | || |  |  |||   |    |||| |  |  | | | |   |||      \n|     || |||||   ||| | |      || | |    |||\\++++++++++-++---+---++----++++----++++---++--+---+++--+-++-+--+--+++---+----++++-+--+--/ | | |   |||      \n|     || |||||   |\\+-+-+------++-+-+----+++-++++++++++-++---+---++----++++----++++---++--/   |||  | || |  |  |||   |    |||| |  |    | | |   |||      \n|     || |||||   | | | |      || | |    ||| |||||||||| ||   |   \\+----++++----++++---++------+++--+-+/ |  |  |||   |    |||| |  |    | | |   |||      \n|     || |||||   | | | |      || | |    \\++-++++++++++-++---+----+----++++----++++---++------+++--+-+--+--+--+/|   |    |||| |  |    | | |   |||      \n|     || |||||   | | | |      || | |     || |||||||||| ||   |    |    ||||    ||||   ||      |||  | |  |  |  | |   |    |||| |  |    | | |   |||      \n|     || |||||   | | | |      || | |     || |||||||||| ||   |    |    ||||    ||||   ||      |||  | |  |  |  | |   |    |||| |  |    | | |   |||      \n|     |\\-+++++---+-+-+-+------++-+-+-----++-+++++++/|| ||   |    |    ||||    ||||   ||      |||  | |  |  |  | |   |    |||| |  |    | | |   |||      \n|     |  |||||   | | | |      || | |     |\\-+++++++-++-+/   |    |    ||||    ||||   ||      |||  | |  |  |  | |   |    |||| |  |    | | |   |||      \n|     |  |||||   | | | |      || | |     |  ||||||| \\+-+----+----+----++++----++++---++------+++--+-/  |  |  | |   |    |||| |/-+----+-+-+---+++---\\  \n|     |  |||||   | | | |      \\+-+-+-----+--+++++++--+-+----+----+----++++----++++---++------+++--+----+--+--+-+---+----++++-++-/    | | |   |||   |  \n|     |  |||||   | | | |       | | |     |  |||||||  |/+----+----+----++++----++++---++------+++--+----+--+--+-+---+----++++-++------+-+-+---+++---+\\ \n|     |  |||||   | | | |       | | |     |  |||||||  |||    |    |    |\\++----++++---++------+++--+----+--+--+-+---+----++++-++------+-/ |   |||   || \n|     |  \\++++---+-+-+-+-------+-+-+-----+--+++++++--/||    |    |    | ||/---++++---++------+++--+----+--+--+-+---+----++++-++--\\   |   |   |||   || \n|     |   ||||   | | | |       | | |     |  |||||||   ||    |    |    | |||   ||\\+---++--<---+++--+----+--+--+-+---+----/||| ||  |   |   |   |||   || \n|     |   ||||   | | | |       | | |     |  |\\+++++---++----+----+----+-+++---++-+---++------+++--+----+--+--+-+---+-----+++-++--+---+---+---++/   || \n|     |   ||||   | | | |       | | |     |  | |||||   ||    |    |    | |||   || |   ||      |||  |    |  |  | |   |     ||| ||  |   |   |   ||    || \n|     |   ||||   | | | |       | | |     |  | |||||   ||    |    |    | |||   || |   \\+------+/|  |    |  |  | |   |     ||| ||  |   |   |   ||    || \n|     |   ||||   | | | |       | | |     |  | |||||   ||    |    |    | |||   || |    |      | |  |    |  |  | |   |     ||| ||  |   |   |   ||    || \n|     |   \\+++---+-+-+-+-------+-+-+-----+--+-+++++---++----+----+----+-+++---++-/    |      | |  |    |  |  | |   |     ||| ||  |   |   |   ||    || \n|     |    |||   | | | |       | | |   /-+--+-+++++---++----+----+----+-+++---++------+------+-+--+----+--+\\ | |   |     ||| ||  |   |   |   ||    || \n|     |    ||\\---+-+-+-+-------+-/ |   | |  | |\\+++---++----/    \\----+-+++---/|      |      | |  |    |  || | |   |     ||| ||  |   |   |   ||    || \n|     |    || /--+-+-+-+-------+---+\\  | |  | | |||   ||              | |||    |      \\------+-+--+----+--/| \\-+---+-----+/| ||  |   |   |   ||    || \n|     |    \\+-+--+-+-+-+-------+---++--+-+--/ | |||   ||              | |||    |             | |  |    |   |   |   |     | | ||  |   |   |   ||    || \n|     |     | |  | |/+-+-------+---++--+-+----+-+++---++--------\\     | |||    |             | |  |    |   |   |   |     | | ||  |   |   |   ||    || \n|     |    /+-+--+-+++-+-------+---++--+-+----+-+++---++--------+-----+-+++----+----------->-+-+--+----+---+---+\\  |     | | |\\--+---+---+---++----/| \n|     |    || |  | ||| | /-----+--\\||  | |    | |||   ||        |     | |||    |             | |  | /--+---+---++--+-----+-+-+---+--\\|   |   ||     | \n|     |    || |  | ||| | |     |  |||  | |    | |||   ||        |     | ||\\----+-------------+-+--+-+--+---+---++--+-----+-+-+---/  ||   |   ||     | \n|     |    || |  | ||| | |     |  |||  | |    | |||   ||        |     | ||     |             | |  | |  |   |   ||  |     | | |      ||   |   ||     | \n\\-----+----++-+--+-+++-+-+-----/  |||  | |    | |||   ||        |     | ||     |             | |  \\-+--+---+---++--/     | | |      ||   |   ||     | \n      |    || |  | ||\\-+-+--------+++--+-+----/ |||   ||        |     | ||     |             | |  /-+--+---+---++--------+-+-+------++---+---++\\    | \n      |    || |  | ||  | |        |||  | |      |||   ||        |     | ||     |             | |  | |  |   |   ||        | | |      ||   |   |||    | \n      \\>---++-+--/ ||  | |        |||  \\-+------+++---++--------+-----+-++-----+-------------+-+--+-+--+->-/   ||        \\-+-+------++---+---+/|    | \n           || \\----++--+-+--------++/    |      |\\+---++--------+-----+-++-----+-------------+-+--+-+--+-------++----------+-/      ||   |   | |    | \n           ||      ||  | |        ||     |      | |   \\+--------+-----+-++-----+-------------+-+--+-+--+-------++----------+--------++---+---+-+----/ \n           ||      ||  | |        ||     |      | \\----+--------+-----+-++-----+-------------+-/  | |  |       ||          |        ||   |   | |      \n           |\\------++--+-+--------++-----+------+------+--------+-----+-++-----+-------------/    | |  |       ||          \\--------++---+---/ |      \n           |       |\\--+-+---<----++-----+------+------+--------/     | ||     |                  | |  |       ||                   ||   |     |      \n           |       |   | \\--------/|     |      |      \\--------------+-/|     |                  | \\--+-------++-------------------/|   |     |      \n           |       |   |           \\-----+------+---------------------+--+-----+-------<----------+----/       \\+--------------------/   |     |      \n           |       \\---+-----------------+------/                     |  |     |                  |             |                        |     |      \n           |           |                 |                            \\--+-----/                  \\-------------+------------------------+-----/      \n           \\-----------+-----------------+-------------------------------+--------------------------------------/                        |            \n                       \\-----------------/                               \\---------------------------------------------------------------/            ")
;(def input "/->-\\        \n|   |  /----\\\n| /-+--+-\\  |\n| | |  | v  |\n\\-+-/  \\-+--/\n  \\------/   ")
;(def input "/>-<\\  \n|   |  \n| /<+-\\\n| | | v\n\\>+</ |\n  |   ^\n  \\<->/")

(def INPUT-LAYOUT
  (->> input
    (str/split-lines)
    (map-indexed vector)
    (reduce
      (fn row-rf [m [y row]]
        (reduce
          (fn col-rf [m [x sym]]
            (if (= \space sym)
              m
              (assoc! m [x y] sym)))
          m
          (map-indexed vector row)))
      (transient {}))
    (persistent!)))

(def ROAD-UNDER-CART
  {\^ \|
   \v \|
   \> \-
   \< \-})

(def CART-SYM #{\^ \> \v \<})

(defn make-cart [[[x y] direction]]
  {::x     x
   ::y     y
   ::dir   direction
   ::turns (cycle [:turn/left :turn/straight :turn/right])})


(def INITIAL-CARTS
  (->> INPUT-LAYOUT
    (filter #(-> % val CART-SYM))
    (map make-cart)))


(def ROAD
  (reduce
    (fn rf [m {::keys [x y]}]
      (update m [x y] ROAD-UNDER-CART))
    INPUT-LAYOUT
    INITIAL-CARTS))


(def DECISION
  {:turn/right    {\^ \>  \> \v  \v \<  \< \^}
   :turn/left     {\^ \<  \< \v  \v \>  \> \^}
   :turn/straight identity})


(defn turn [{:as cart ::keys [x y turns]}]
  (let [road (get ROAD [x y])]
    (case road
      \- cart
      \| cart
      \/ (update cart ::dir {\^ \>  \> \^  \< \v  \v \<})
      \\ (update cart ::dir {\^ \<  \< \^  \> \v  \v \>})
      \+ (-> cart
           (update ::dir (-> turns first DECISION))
           (update ::turns rest)))))


(defn move [{:as cart ::keys [dir]}]
  (case dir
    \< (update cart ::x dec)
    \> (update cart ::x inc)
    \^ (update cart ::y dec)
    \v (update cart ::y inc)))


(def coords   (juxt ::x ::y))

(defn priority [[x1 y1] [x2 y2]]
  (compare [y1 x1] [y2 x2]))


(defn sorted-index-by-xy [carts]
  (apply sorted-map-by priority (interleave (map coords carts) carts)))



(def r1
  (time
    (loop [todo (sorted-index-by-xy  INITIAL-CARTS)
           done {}]
      (if (empty? todo)
        (recur (-> done vals sorted-index-by-xy) {})
        (let [[cur-xy cur-cart] (first todo)
              new-cart (-> cur-cart move turn)
              new-xy   (coords new-cart)
              standby  (dissoc todo cur-xy)]
          (if (or (contains? done    new-xy)
                  (contains? standby new-xy))
            new-xy
            (recur standby (assoc done new-xy new-cart))))))))


(def r2
  (time
    (loop [todo (sorted-index-by-xy INITIAL-CARTS)
           done {}]
      (cond
        (and (-> todo count (= 0))
             (-> done count (= 1)))
        (-> done first key)

        (empty? todo)
        (recur (-> done vals sorted-index-by-xy) {})

        :else
        (let [[cur-xy cur-cart] (first todo)
              new-cart (-> cur-cart move turn)
              new-xy   (coords new-cart)
              standby  (dissoc todo cur-xy)]
          (if (or (contains? done    new-xy)
                  (contains? standby new-xy))
            (recur (dissoc standby new-xy) (dissoc done new-xy))
            (recur standby (assoc done new-xy new-cart))))))))



(assert (= r1 [80 100]))
(assert (not= r2 [113 82]))
(assert (not= r2 [113 84]))
(assert (not= r2 [113 83]))
(assert (= r2 [16 99]))
