(ns adventofcode.y2020.day20
  (:require
   [clojure.string :as str]
   [clojure.set :as set]))


(def t "Tile 2311:\n..##.#..#.\n##..#.....\n#...##..#.\n####.#...#\n##.##.###.\n##...#.###\n.#.#.#..##\n..#....#..\n###...#.#.\n..###..###\n\nTile 1951:\n#.##...##.\n#.####...#\n.....#..##\n#...######\n.##.#....#\n.###.#####\n###.##.##.\n.###....#.\n..#.#..#.#\n#...##.#..\n\nTile 1171:\n####...##.\n#..##.#..#\n##.#..#.#.\n.###.####.\n..###.####\n.##....##.\n.#...####.\n#.##.####.\n####..#...\n.....##...\n\nTile 1427:\n###.##.#..\n.#..#.##..\n.#.##.#..#\n#.#.#.##.#\n....#...##\n...##..##.\n...#.#####\n.#.####.#.\n..#..###.#\n..##.#..#.\n\nTile 1489:\n##.#.#....\n..##...#..\n.##..##...\n..#...#...\n#####...#.\n#..#.#.#.#\n...#.#.#..\n##.#...##.\n..##.##.##\n###.##.#..\n\nTile 2473:\n#....####.\n#..#.##...\n#.##..#...\n######.#.#\n.#...#.#.#\n.#########\n.###.#..#.\n########.#\n##...##.#.\n..###.#.#.\n\nTile 2971:\n..#.#....#\n#...###...\n#.#.###...\n##.##..#..\n.#####..##\n.#..####.#\n#..#.#..#.\n..####.###\n..#.#.###.\n...#.#.#.#\n\nTile 2729:\n...#.#.#.#\n####.#....\n..#.#.....\n....#..#.#\n.##..##.#.\n.#.####...\n####.#.#..\n##.####...\n##..#.##..\n#.##...##.\n\nTile 3079:\n#.#.#####.\n.#..######\n..#.......\n######....\n####.#..#.\n.#...#.##.\n#.#####.##\n..#.###...\n..#.......\n..#.###...")
(def i "Tile 3469:\n.##..#.#.#\n##..#...##\n...#..##.#\n....#.#..#\n#..#.##...\n.#.##.#.##\n..#.#.....\n..###.#..#\n#.##.#...#\n....#...##\n\nTile 3739:\n..##..#..#\n#.#...#..#\n.....#.##.\n.#..#....#\n#.....#...\n#..##.#..#\n####.#.##.\n##..#.#..#\n..#......#\n#..#.##.##\n\nTile 3581:\n####.#..##\n..#......#\n.##...#...\n#....#.###\n..#..#.#..\n#...#.....\n#..####...\n......#...\n..#...#.##\n##.#..#..#\n\nTile 2521:\n..#.##..##\n..#.#..##.\n#.........\n#.#.......\n.#........\n#.....#..#\n..........\n.#........\n#........#\n#.....#.#.\n\nTile 2729:\n...##...##\n....#..#..\n#...##....\n##.#......\n#..#..#.##\n.#...#...#\n....#.##..\n#.....##.#\n#....##..#\n......#.#.\n\nTile 2137:\n#.#...#.##\n#.......#.\n.#.#..#..#\n##.....#.#\n.....#...#\n...#......\n#........#\n....#....#\n.......#..\n.#.#.#####\n\nTile 1451:\n...#.#.##.\n##.#......\n.###...#.#\n..##....##\n....##....\n...#..#...\n...#..#.#.\n##..#....#\n#..#...##.\n.###....##\n\nTile 2927:\n.#...#....\n.#.......#\n#...#....#\n##.......#\n..#....#.#\n#.#....#..\n#....#..##\n#........#\n#.#.......\n#########.\n\nTile 2179:\n...#..#..#\n#....##...\n....#...##\n...#.#..##\n#........#\n..#.#...##\n.#........\n.###.####.\n....#.#..#\n..#.#.....\n\nTile 2267:\n#.##...##.\n.....#...#\n..###...##\n.....#..##\n.....#...#\n##........\n#..#..#...\n....##....\n....#....#\n###.####..\n\nTile 2423:\n....###.##\n#....#.#..\n#......#.#\n...#.....#\n......#..#\n.#......##\n#.#......#\n..........\n...#..##..\n##.##...##\n\nTile 3989:\n.#.#....#.\n#........#\n..##....##\n.#.###.##.\n.....#....\n#...##.##.\n#....##..#\n#.........\n#....#....\n.#..###...\n\nTile 1913:\n.####...##\n#.........\n....#...#.\n#.......##\n#...#....#\n#...#.....\n.#.##...#.\n.......#..\n##..#...#.\n.##..#.##.\n\nTile 2017:\n.#.##.###.\n#.....#...\n..#..#...#\n#........#\n......#.#.\n#...#....#\n#.#.#...#.\n.###.#....\n.##...####\n#.##.#####\n\nTile 1277:\n.##...#.##\n#..#.....#\n#.#.#...##\n#.#.#...##\n.####....#\n....#....#\n.....#....\n#....####.\n#.........\n#...#...#.\n\nTile 1999:\n.##.##..#.\n#.........\n#...#.....\n...#......\n#.#.....#.\n....#....#\n........##\n#......#.#\n..#.#....#\n.#.#.#....\n\nTile 2803:\n#......##.\n..##.##...\n...#.#....\n#...#....#\n....#.#..#\n#...#...##\n.........#\n#...#.##..\n....##.#.#\n#..#..#.#.\n\nTile 1801:\n...#.###.#\n...#.###..\n...##..#.#\n....##.###\n##.......#\n....#.#..#\n##.###..#.\n...#...#.#\n#.##..##..\n###......#\n\nTile 1009:\n...#..#.#.\n#.##.#....\n#.....##..\n#.#..#....\n#.........\n#....#.#.#\n#....##..#\n..##......\n..#.#...#.\n##.###.#.#\n\nTile 3329:\n..#.###...\n.#....#.#.\n..........\n#....##..#\n##.##..###\n..........\n..........\n#...#.#...\n###.#..###\n#####.##.#\n\nTile 3719:\n..#.###.#.\n#....#...#\n##..#.##.#\n....#.###.\n##.....#.#\n##....#...\n##.......#\n#.#......#\n.##...#.#.\n####..##.#\n\nTile 2381:\n##.#......\n#.....#...\n#.....#...\n.....##...\n..##...##.\n###......#\n#.....#.##\n..#...####\n#.#...#..#\n#..#......\n\nTile 2593:\n###.#.###.\n..#.##..##\n#.#......#\n....#.####\n..#...##.#\n..#.#.#...\n#.##......\n..#..#...#\n.##.##...#\n.###.##.##\n\nTile 3559:\n...#...#..\n#..#.#.#..\n..........\n.#.#......\n..#......#\n....#....#\n.......###\n...#..###.\n..#.#...#.\n..#.##.##.\n\nTile 2953:\n#.##.....#\n.........#\n#...#.....\n#...#....#\n...#....#.\n#..#...#..\n#.....#.##\n#...#.#..#\n...###..##\n..#..##..#\n\nTile 1283:\n..#..#.#.#\n##.....#.#\n.........#\n#.....#...\n###......#\n..#.#.####\n#..#.....#\n..#...#..#\n###.##....\n...#...###\n\nTile 2897:\n.......###\n##.#....#.\n#.....####\n##...#...#\n.....#....\n#.....#...\n.##...##..\n.....#...#\n......#..#\n.#....##.#\n\nTile 3779:\n###..####.\n#..##..#.#\n#.#...#..#\n......#..#\n#....#....\n...#...##.\n......####\n##....#..#\n#.#....#..\n#####....#\n\nTile 2693:\n#.#.#.####\n..........\n#.#.#....#\n..#.#..#.#\n##.....#.#\n##....#...\n.##.#.....\n##.......#\n.....#....\n.###.#..#.\n\nTile 1453:\n#..##....#\n#..#....#.\n#.#....##.\n.##.#....#\n..#.#....#\n.###.....#\n....##....\n#...##...#\n#.###.....\n.##....#..\n\nTile 1459:\n.##.##.###\n..#.......\n......##.#\n##...#...#\n#.#.....##\n#.#......#\n...##.#...\n###..#...#\n...#....#.\n...##.#.##\n\nTile 1109:\n#.#.#.#..#\n#..#.####.\n.....##..#\n.##...#..#\n.#...###.#\n........#.\n.....#.#.#\n...#...###\n....#.#..#\n##..#..##.\n\nTile 3943:\n...###....\n##...###.#\n####.....#\n#.........\n.#......#.\n..#..#.#.#\n..#....#..\n##..#....#\n#..#.....#\n#.##..#.##\n\nTile 1129:\n###...##..\n....#....#\n#........#\n#......#..\n..#...#...\n#......#.#\n....#...#.\n.....#....\n##......##\n#..####.#.\n\nTile 2837:\n...###.#.#\n#......#..\n..#.....##\n.....#...#\n#......#..\n..........\n#......#..\n#.#.....##\n#.#.#.....\n.####.##..\n\nTile 3299:\n####..#...\n#........#\n#...#..#.#\n#.#....#..\n#...#.....\n...##.#..#\n#.#.....##\n..##......\n#...#.#..#\n#.###..##.\n\nTile 1493:\n#..##..#.#\n###......#\n..........\n...#.....#\n....#.....\n...#.....#\n.#........\n...###..#.\n.#.#...#.#\n####.#.#..\n\nTile 3931:\n#.####....\n.....###.#\n...#....#.\n#.#....#.#\n#..#.....#\n#........#\n...##..#..\n.....#....\n#..#...#.#\n#.###.##..\n\nTile 2879:\n#####.....\n##.#.#...#\n#.....#.##\n##....#.##\n#..#......\n#.#...#...\n..#.....#.\n...#...###\n...#....##\n.#.###.#..\n\nTile 2617:\n##.#.#.#.#\n.....#.#..\n#...#.....\n#...##...#\n.#.......#\n#.#.......\n##..#.....\n#......###\n..#..#...#\n.###..#..#\n\nTile 2383:\n..#.#..#.#\n#..#......\n#...#.#...\n....##...#\n.#..#.#..#\n#####....#\n#.#......#\n#........#\n..##...###\n.##.##.###\n\nTile 3373:\n.##..####.\n...#..#.##\n#..#.....#\n####...#.#\n#..#..#...\n#.#....##.\n##.#....##\n.#..##..#.\n.##..#...#\n######..#.\n\nTile 3803:\n.#..#.##..\n.......##.\n#....#....\n..#......#\n...##.....\n#.........\n..##......\n#.#...#..#\n..##.....#\n#..#####..\n\nTile 3677:\n.#.#####.#\n#...#.....\n.....#....\n..#......#\n.#.#...#.#\n..###.##..\n##...##..#\n#..#......\n#...#..#..\n...#####.#\n\nTile 3323:\n####.#..#.\n#..#.##..#\n#.........\n.#.......#\n#.#.....#.\n#..#.....#\n#....##.#.\n.......#.#\n#####..#..\n.#.##.####\n\nTile 3457:\n.#.#..#..#\n.#..#.....\n..##..#...\n......#..#\n.#.....#.#\n#.........\n#..#..#.#.\n#####....#\n###.#...#.\n#..###.###\n\nTile 1303:\n##..#.####\n#.#..#....\n.....#...#\n#.#.......\n#..####...\n#...##....\n###..#..##\n##.......#\n#...#..#.#\n#..#.#..##\n\nTile 2687:\n.####...##\n#..#.....#\n..#...#...\n##.....#.#\n#.....#..#\n#.........\n...#.#...#\n.........#\n#..#.....#\n#.##.#...#\n\nTile 1907:\n..#....###\n....#...##\n..#.##..#.\n.#....##..\n......#...\n......#.#.\n#.....#.##\n..#...#...\n....#....#\n#####.####\n\nTile 3217:\n#.##.##...\n#..#.##...\n.#..#.##..\n#.....#.#.\n....#.....\n###.#.##..\n.#.#.###..\n#.........\n#......#.#\n#.###..##.\n\nTile 3923:\n#.##.#..##\n......#..#\n#.....#...\n..#.#.....\n#........#\n.#...#...#\n.....#...#\n.#..#.##.#\n..#..#...#\n..#####.##\n\nTile 2239:\n#.#.###.##\n#..#..#...\n.##..#....\n#...##..#.\n#........#\n..#.#.....\n##.##.....\n#.#..###.#\n##..##....\n#.#.#..##.\n\nTile 1823:\n###..###..\n.#.##...#.\n..###....#\n#.#..#...#\n###.#.....\n#.#...#.##\n#...##..##\n##.#...#.#\n#....#.###\n.#.##.#..#\n\nTile 2711:\n.#.#.....#\n.....#..##\n..#..#..##\n#.........\n..........\n#.##..##.#\n####..####\n###.......\n........#.\n.#.#.####.\n\nTile 1123:\n###.#.##.#\n........##\n.......##.\n.#........\n.#....#..#\n###.#.##..\n..##......\n#.#.#.....\n##...#..##\n###..#####\n\nTile 3659:\n...##.##..\n.#....#...\n.#..#.....\n..........\n.....#.#..\n...#...###\n#.....#...\n.#........\n#..#......\n#...#.#..#\n\nTile 3499:\n###..##.#.\n#..##....#\n###.#.....\n#####.....\n..#.......\n###..#.#..\n......##.#\n.#.......#\n#.##.#...#\n.#.#.##.##\n\nTile 3019:\n#..#.###..\n....#....#\n.#......##\n###.#....#\n..#.#.....\n..##....#.\n.#..#..#.#\n.........#\n....#...##\n##..#.#..#\n\nTile 3529:\n####....##\n..##...#.#\n#.........\n...#......\n......#..#\n##......##\n#.##....##\n##.#...#.#\n#.#.......\n###.##..#.\n\nTile 1733:\n##..#....#\n....#.....\n#.#......#\n..#..#...#\n...#....#.\n.....#....\n.......#.#\n......#..#\n#.#.#..###\n.###.#.##.\n\nTile 1367:\n#.#.###.#.\n#.##.##.#.\n##..#.##..\n#.....####\n.##...#..#\n...##.#..#\n#.......##\n.##..##..#\n#.##......\n#...###...\n\nTile 2557:\n##.#######\n#..#####..\n##.#.#...#\n#..#.#....\n.#..#....#\n###...#..#\n##..#.#...\n#...##..##\n#.#.##.#.#\n#.#...#..#\n\nTile 2081:\n.###..#..#\n.....#....\n##.....#..\n..........\n..........\n#.##......\n.........#\n......#.#.\n...#.....#\n...###.#.#\n\nTile 3391:\n.##.#.....\n...###...#\n..#.##....\n#...#.#..#\n#......##.\n#........#\n...#..#..#\n.....#....\n.#...#....\n##....#...\n\nTile 2657:\n#.#.##.#..\n##...#....\n..#...#...\n#.........\n.........#\n##........\n##...#....\n##.....#..\n...#...#.#\n##...###..\n\nTile 1429:\n.###.....#\n#........#\n..#.#..#..\n.......###\n.......#..\n.......##.\n##..#...##\n.#......#.\n..#....#..\n.##.##....\n\nTile 2339:\n.#.####...\n#......#..\n#.#...##..\n##....##.#\n......##.#\n.#......#.\n.#...#..##\n#........#\n#.##.#.###\n..#..#.#..\n\nTile 2347:\n..###..###\n..###.....\n#..#..##..\n#......#..\n#.#..#.#.#\n......##..\n.#..#..#..\n..#.....##\n#.##..##..\n#..###....\n\nTile 2957:\n...#.####.\n#.....#...\n#..#......\n#.....#.#.\n..#.#..#.#\n....#...##\n###.#.##.#\n.#...##..#\n#........#\n#.#.####..\n\nTile 2477:\n.###.##.##\n.#.....#..\n#......#..\n....##.#..\n##........\n..#....#.#\n##...#.###\n.#.#..#...\n..#..#.#.#\n.....#.#.#\n\nTile 1669:\n#.##..#.##\n.#......#.\n#####..#.#\n..##...#.#\n#.#..#....\n##........\n##.#......\n##..#....#\n##.#..#..#\n##...##.##\n\nTile 2887:\n######.#..\n#..#..##.#\n#..#..#..#\n#..###..#.\n#........#\n.....##..#\n.#..##.#..\n..........\n##..#.#..#\n##.#..#..#\n\nTile 3517:\n.#....#.##\n#..#.##.#.\n..........\n##...#..##\n#.........\n#...#.#..#\n#...#..#..\n...#......\n..........\n#......#.#\n\nTile 3257:\n####.....#\n.#...##...\n#.#.#.#..#\n#.##......\n##.#..#...\n.##.##..#.\n#......#.#\n..##......\n#...#....#\n#...##.###\n\nTile 2029:\n#.#.....##\n.........#\n.#..#.....\n...#.....#\n...#.###.#\n....#.#..#\n..........\n#..#..#...\n#........#\n.#####..##\n\nTile 1777:\n###....#..\n#..#......\n......##..\n.....#.#..\n##....#..#\n#..#...#..\n..##....##\n##..#..#..\n#......#.#\n.#.....##.\n\nTile 3881:\n#..###..#.\n##.#.##..#\n#.........\n#...#.#..#\n#.........\n.#..#.#.##\n....#.....\n#..###.#..\n#..##.#..#\n###..#.#.#\n\nTile 3919:\n.##..##..#\n..........\n......#...\n..........\n...#.#..##\n#........#\n......###.\n#....#.##.\n..#.....##\n.##.##....\n\nTile 1051:\n####..###.\n.....##...\n#.#......#\n..#.....#.\n#....#...#\n##.#..####\n......####\n#..#.....#\n#......#..\n##.#####..\n\nTile 2539:\n.#.#.#..##\n.#.#.#..##\n..##...#.#\n...#...#.#\n#...#..##.\n#...##.##.\n.#....#..#\n....#...#.\n#.##..###.\n.##.###...\n\nTile 2833:\n#####.###.\n.#...#...#\n.........#\n..#.#.#..#\n####..#..#\n#..#......\n#.##..#...\n#.##....##\n#.#..#.##.\n##.#.##.#.\n\nTile 1297:\n.#.#.####.\n..........\n##..#####.\n#....##..#\n.#.......#\n.#.##.....\n#.#.#.#..#\n...#..#...\n#...#.#..#\n.#...#####\n\nTile 1093:\n.##..#...#\n#.#.#.....\n....#...#.\n...#....##\n....##..#.\n#.......##\n...#.#...#\n#...#.#..#\n....#..#.#\n####.#.#..\n\nTile 2843:\n.#.#..##..\n..#...###.\n....#.#..#\n###..#.##.\n..#....#..\n#.........\n#...#..#.#\n#.#...#..#\n##..####..\n...#####..\n\nTile 2243:\n...##..#.#\n.......#..\n#........#\n....#....#\n.........#\n#..#......\n..#..#.#.#\n.#.#.##...\n#...##.#..\n....###.##\n\nTile 1091:\n..######.#\n.##..#..#.\n........##\n##..#.#.#.\n.....###..\n..#...#..#\n..#.#.#...\n...#.....#\n#.#.##.#.#\n#.....##.#\n\nTile 2609:\n#.#.#...##\n#..#..#..#\n...####...\n..#.#..#.#\n#...##.#..\n#.##.#..##\n#..##....#\n#.#...#.#.\n.#...##...\n.#.###...#\n\nTile 3527:\n.#....###.\n#..#...#.#\n........##\n#.#..#..#.\n.......#.#\n........##\n#.....#...\n##..####..\n#..##...#.\n.#.#.##..#\n\nTile 1229:\n.#####.##.\n...#.#....\n#.#.##...#\n.#...##..#\n#....#...#\n#.#..#...#\n.#....#...\n....#....#\n#.#......#\n#.#####.##\n\nTile 2549:\n.#####....\n#........#\n.#.##.....\n#.#...#..#\n#.#......#\n...#..#..#\n...#...#..\n##...##..#\n.#.#......\n####.#...#\n\nTile 2131:\n#.#..#.#.#\n##..#.....\n#.#..##..#\n#...#....#\n###.......\n#..#######\n....#.....\n#...#....#\n...#.#...#\n#...#...#.\n\nTile 1201:\n#...#.#.##\n.....#....\n##..#.#..#\n...#..#..#\n.....#...#\n..##..#.##\n#.#.#..#.#\n.....#.#.#\n###.#.#..#\n..#.##...#\n\nTile 1321:\n.#..#...##\n#.#...##..\n...#.....#\n#....##..#\n#.........\n.#.......#\n#.##....#.\n.#..##.###\n#...#...##\n#.########\n\nTile 2999:\n.......#..\n.....#....\n.##.......\n#..#.....#\n#...#.....\n####.#..#.\n.#...###.#\n##.....#.#\n#.####...#\n.##.......\n\nTile 1621:\n####.....#\n..#..#..#.\n.#...###..\n##...##...\n#..#......\n#..##.#...\n...#..#..#\n.##...##.#\n......#..#\n.#..#...#.\n\nTile 1483:\n.#####..#.\n.#...#...#\n#.#.#..#..\n....####..\n#..#..####\n...##.....\n....#.#...\n..#..##...\n#..##.#...\n.###...#.#\n\nTile 1579:\n.#..######\n##..#....#\n..#......#\n#...#..#..\n#........#\n#.#.#.#..#\n#..#.##.##\n#....##.##\n.#....##..\n##...#####\n\nTile 2251:\n.#.###..##\n...##....#\n........##\n..#..#####\n#..#..#..#\n#......#..\n##.##....#\n#........#\n........##\n#.###...#.\n\nTile 1511:\n#..##.##.#\n..#.....##\n##.......#\n##...#...#\n#.##.##.##\n#......#..\n#..#......\n#.#...##.#\n.#........\n..#..##.##\n\nTile 3613:\n##.###..##\n....#..##.\n##..#.#...\n..###.##.#\n.#.###....\n#.#.##....\n.#.#..##..\n#.......#.\n......###.\n.#..###.##\n\nTile 1663:\n#...#...##\n......#.#.\n###.#.#..#\n#..#......\n#.....#.#.\n..........\n#.....##..\n..........\n...#.#...#\n#.##..#...\n\nTile 1997:\n##...#....\n.#.#.....#\n##.#.#....\n.#.#..#...\n...#.#....\n.##.##.##.\n#...####.#\n..#.......\n#.#...#...\n.#..#.....\n\nTile 2371:\n#.###.#...\n##...###.#\n#....##.##\n#......#.#\n##..##....\n#.#...##.#\n##...##..#\n.....#...#\n.##.......\n##.....#.#\n\nTile 3709:\n.#..##.#.#\n###.#..#..\n##.#..##..\n##.....#.#\n..........\n#......##.\n....#...#.\n.#...#....\n.#......##\n.#....####\n\nTile 2143:\n######.#..\n##..#...#.\n#...#.....\n.#.#...#.#\n.....#....\n........##\n#..#......\n.#.#.....#\n...#....##\n....#..##.\n\nTile 2621:\n##.##.##..\n....#..#.#\n#..###....\n#....#....\n.........#\n##....#...\n###..#...#\n.##.......\n.#....#.##\n..#..#####\n\nTile 3221:\n.....#....\n.....##.#.\n.......#..\n#...#.....\n#..#.#...#\n#.#....#.#\n#........#\n.......##.\n#.#......#\n#..#.#..#.\n\nTile 1447:\n.##..####.\n#........#\n.#......#.\n........##\n...#..####\n.#....#...\n###...#..#\n.#..#.#..#\n#.##.#...#\n.##.#####.\n\nTile 2551:\n.#####..#.\n......#...\n..#.......\n.##.##..##\n..#..#....\n#..#.....#\n......#.##\n#.....#..#\n#...#..##.\n..##...#..\n\nTile 2851:\n####.##..#\n..........\n....##...#\n##.......#\n...##..#.#\n.#......##\n.......#..\n#..#.#....\n.#.....#.#\n.#...#..##\n\nTile 2129:\n#.#.####..\n.#.....#..\n#.........\n#..#......\n#.#...#...\n#......#..\n.#....#..#\n..#.#..#.#\n#..#....##\n#.##.###.#\n\nTile 1753:\n#..#...#.#\n##.......#\n#....##.#.\n#.......##\n#...#...##\n#.##......\n...#..##..\n...#.....#\n###......#\n#......#.#\n\nTile 1471:\n####..##.#\n#......##.\n#..##.#...\n.#...#..##\n##.#.#.#.#\n......#..#\n#...#....#\n#....#..#.\n#..#..##..\n.##.#.###.\n\nTile 1019:\n#..####...\n.....#....\n#.........\n..#......#\n#.#..#....\n.##.#.#...\n....#....#\n#...##...#\n...#......\n#..#####.#\n\nTile 3467:\n......####\n#....##.##\n...##..#.#\n#.....##..\n#.##.#...#\n..##...###\n........#.\n#......##.\n.......##.\n####.#.#.#\n\nTile 1223:\n.#.#..##.#\n#.........\n#.#...#..#\n.....#...#\n###..#....\n#..###...#\n.....#..##\n#..#..##..\n.#.###....\n##.##.##.#\n\nTile 2293:\n##..#..##.\n......#...\n#......#..\n..#.......\n#..#...###\n..#....##.\n......####\n....###.#.\n#..##.##.#\n..#...#..#\n\nTile 2647:\n.#.#......\n..#..##..#\n.....#....\n#......##.\n#........#\n#.#..#...#\n#....##..#\n##...#....\n....#....#\n#.#...####\n\nTile 1931:\n.#..##.#.#\n##.#.....#\n#...#....#\n#....#.#.#\n.#....##.#\n...#..#..#\n##..##...#\n##........\n.#..#....#\n...#..###.\n\nTile 2819:\n.##.###.#.\n.........#\n#...#....#\n#...#.##..\n.....##.#.\n.#..##...#\n#....#..#.\n#..#.##.##\n#..##....#\n.......###\n\nTile 2749:\n##..#...#.\n#..##....#\n###......#\n##...#.##.\n#.###..##.\n.#.##....#\n#.......#.\n...#...#..\n#...#...#.\n.#..##...#\n\nTile 2309:\n#......###\n##....#..#\n#..#...###\n#.......##\n##........\n..#####..#\n..##..#..#\n..#.......\n#......#..\n.###..#.##\n\nTile 2203:\n..#..#..#.\n.#....##.#\n.........#\n...#.#....\n#.....#...\n.......#..\n#........#\n#....#..##\n.....#.#.#\n.#.###.###\n\nTile 1697:\n...#.#..#.\n#.......#.\n.##....#.#\n#....#.##.\n....#..###\n....#..#.#\n....#..#.#\n##..##..##\n.......#..\n..#.#.#...\n\nTile 3413:\n#.#.#...##\n......#..#\n...###....\n...###....\n....#.#..#\n.....##...\n.........#\n......#...\n.....#....\n.##....#..\n\nTile 3169:\n..#.#.##..\n..........\n#.........\n##..#..##.\n......#..#\n#..#.#....\n#.#.......\n.......##.\n..#.##.#..\n.#..##.##.\n\nTile 2153:\n#.#.#.#.##\n#.....#..#\n........##\n#....##...\n#...#....#\n#.#.......\n#.####..#.\n...#.###.#\n..#.#.....\n##.##.##.#\n\nTile 1031:\n.######.#.\n....##...#\n...##...#.\n....##..##\n.#...##...\n.........#\n.#...#..#.\n......#..#\n..##.....#\n##....####\n\nTile 1097:\n.#.#.#.###\n#..###.#.#\n....#.....\n...#..#..#\n.#....##.#\n#..#.#....\n....#..##.\n##.###.#.#\n...#.#..#.\n.#.#.##...\n\nTile 1789:\n###...##..\n#.........\n...#.....#\n#....#....\n##...#....\n...#...#..\n....#..#.#\n..........\n..#.#..#.#\n###.#..###\n\nTile 3701:\n#...#.#.##\n#.#...#..#\n#....#...#\n.....#..##\n#.....##.#\n...#..##.#\n#.....#...\n#...#.....\n#.......#.\n#...#.##.#\n\nTile 3617:\n#...##.#..\n..##...#..\n...##.....\n.#.....###\n..#.#####.\n###.#.#.#.\n.#.#.#...#\n#....##...\n#.....###.\n##.#...###\n\nTile 3727:\n####...##.\n#..#....##\n##.#.##..#\n...##.##..\n....#.....\n##....##..\n#....##.##\n....##....\n##..##....\n.#....##.#\n\nTile 3343:\n...##.#...\n..#.#.....\n.....#..#.\n#...##.#..\n#.#.#....#\n...#......\n....##..##\n...#######\n.#..#....#\n.#.###...#\n\nTile 3313:\n...####.##\n#.#.#.....\n#..##...##\n.#.#.##..#\n#...#....#\n..#..#....\n.#..#.....\n##.##...##\n...#......\n.###....##\n\nTile 1847:\n..##.##.##\n##...#.#..\n##...#....\n#.#......#\n#....#....\n.......##.\n##.#.#.#.#\n...#..#..#\n....#..#..\n#..##..##.\n\nTile 3557:\n..#..#####\n......#..#\n#.....#..#\n..#.......\n#.......##\n###.#....#\n.#.....#.#\n##........\n#...#.....\n.##...#.##\n\nTile 1867:\n...##.###.\n#......##.\n#.#.#...#.\n#........#\n#.....#...\n#....#...#\n.#..#.#...\n...###....\n##.#..#.##\n#..#.###..\n\nTile 2039:\n##.#.#####\n#.#....#..\n.#.#.....#\n##.....#..\n###..#..##\n....#.....\n##..##....\n.........#\n..#.#.#..#\n###...#.##\n\nTile 3301:\n..#..##..#\n....#...#.\n#....###..\n.....#..#.\n....##...#\n#......#..\n....#....#\n......####\n.......###\n..#..###.#\n\nTile 1213:\n..#.#..#..\n#.#....###\n..#......#\n##.#......\n..#....###\n...#.....#\n.#.#.....#\n#.#.....##\n..##.#..#.\n...#...#.#\n\nTile 2437:\n#.#####.##\n.##...#.##\n#..#.#...#\n.....#....\n.##...#.#.\n....##.#..\n#...#.....\n##.#..#..#\n#....#..##\n.#.######.\n\nTile 3511:\n.#.###.##.\n...#...#..\n#...#.##.#\n.....#....\n.#........\n........#.\n##.#......\n....#.....\n....#...#.\n.#.##..##.\n\nTile 2719:\n..#.#.###.\n#.##...#..\n...#..##..\n#........#\n.........#\n.....####.\n#.....#.#.\n#.#.......\n...#...##.\n###.##..#.\n")

(read-string "2r00001")

[[1 2]
 [3 4]]
; turn
[[3 1]
 [4 2]]
; flip
[[3 4]
 [1 2]]



(defn flip [square]
  (-> square reverse vec))

(defn turn [square]
  (->> square
    (apply map vector)
    (map reverse)
    (mapv vec)))

(def mops (->> [flip turn] (map memoize) (apply juxt) memoize))

(defn transformations [lines]
  (->> #{lines}
    (iterate (fn [variants]
               (->> variants
                 (map mops)
                 (reduce into variants))))
    (partition 2)
    (drop-while #(apply not= %))
    (ffirst)))

(defn get-edges [lines] ;;TRBL
  [(first lines)
   (mapv peek lines)
   (peek lines)
   (mapv first lines)])

(defn but-edges [lines]
  (->> lines pop rest (mapv #(-> % pop rest vec))))


(defn map-vals [f m]
  (reduce-kv
    (fn [m k v]
      (assoc m k (f v)))
    {} m))

(defn parse-tile2 [text]
  (let [lines (->> text str/split-lines rest (mapv vec))
        id    (read-string (re-find #"\d+" text))]
    (->> lines
      transformations
      (map (fn [rows]
             (assoc
               (zipmap [:t :r :b :l] (get-edges rows))
               :id    id
               :box   (but-edges rows)))))))

(defn index [kf vf coll]
  (reduce
    #(update %1 (kf %2) (fnil conj #{}) (vf %2))
    {} coll))

(defn parse-tiles [input]
  (let [by-id    (-> input
                   (str/split #"\n\n")
                   (->>
                     (mapcat parse-tile2)
                     (group-by :id)
                     (map-vals set)))
        vars     (reduce set/union (vals by-id))]
    (assoc by-id
      :l (index :l identity vars)
      :r (index :r identity vars)
      :t (index :t identity vars)
      :b (index :b identity vars)
      :all    vars
      :width  (-> by-id count Math/sqrt int))))


(parse-tiles t)


(defn make-next-xy [width]
  (fn next-xy [[x y]]
    (if (< x width)
      [(inc x) y]
      [1 (inc y)])))


(defn make-step-fn [width db]
  (let [next-xy      (make-next-xy width)
        intersection (fn [sets]
                       (if (seq sets)
                         (reduce set/intersection (map set sets))
                         (:all db)))]
    ;;{[x y] {:t 576, :r 210, :b 948, :l 234, :id 1427}}}
    (fn step [[used-ids state]]
      (let [[x y] (:next-xy state)
            py    (dec y)
            px    (dec x)
            pr    (get-in state [[px y] :r])
            pb    (get-in state [[x py] :b])
            tiles (->>
                    [(get-in db [:l pr])
                     (get-in db [:t pb])]
                    (remove empty?)
                    (intersection)
                    (remove #(-> % :id used-ids)))]
        (map
          (fn [tile]
            [(conj used-ids (:id tile))
             (-> state
               (update :next-xy next-xy)
               (assoc :prev-xy [x y])
               (assoc [x y] tile))])
          tiles)))))

(defn get-state [input]
  (time
      (let [DB         (time (parse-tiles input))
            {:keys [:width]} DB
            last-xy    [width width]
            done?      #(-> % second (contains? last-xy))
            step       (make-step-fn width DB)
            blank      [#{} {:next-xy [1 1]}]
            corner-xys [[1 1] [1 width] [width 1] last-xy]
            state      (loop [[item & todo] [blank]]
                         (cond
                           (nil? item) :fail
                           (done? item) (second item)
                           :else (recur (into todo (step item)))))
            p1         (-> state (select-keys corner-xys) vals (->> (map :id) (reduce *)))]
        (assoc state :p1 p1 :width width))))

;;140656720229539

(defn glue [state]
  (let [idxs (range 1 (inc (:width state)))]
    (mapv vec
      (apply concat
        (for [y idxs]
          (apply map concat
            (for [x idxs]
              (-> [x y] state :box))))))))

(defn hashes [square]
  (->>
    (for [x (range (count (first square)))
          y (range (count square))]
      (when (= \# (get-in square [y x]))
        [x y]))
    (remove nil?)
    (into #{})))



(def monster
  (->> "                  # \n#    ##    ##    ###\n #  #  #  #  #  #   "
    (str/split-lines)
    (mapv vec)))

(defn offset [[x y] [dx dy]]
  [(+ x dx) (+ y dy)])

(defn offset-all [xys dxdy]
  (into #{} (map offset xys (repeat dxdy))))

(defn waves [width sea monster]
  (let [mx  (->> monster (map first)  (reduce max))
        my  (->> monster (map second) (reduce min))]
    (reduce
      (fn [sea dxdy]
        (let [monster' (offset-all monster dxdy)]
          (if (set/subset? monster' sea)
            (set/difference sea monster')
            sea)))
      sea
      (for [x (range (- width mx))
            y (range (- width my))]
        [x y]))))

;p2
(let [state    (get-state i)
      monsters (transformations monster)
      glued    (glue state)
      width    (count glued)
      patterns (map hashes monsters)
      sea      (-> state glue hashes)
      waves_   #(waves width sea %)]
  (->> patterns
    (map waves_)
    (map count)
    (reduce min)))