(ns adventofcode.y2020.day24
  (:require [clojure.string :as str]
            [clojure.set :as set]
            [adventofcode.utils :as u]))

(def t "sesenwnenenewseeswwswswwnenewsewsw\nneeenesenwnwwswnenewnwwsewnenwseswesw\nseswneswswsenwwnwse\nnwnwneseeswswnenewneswwnewseswneseene\nswweswneswnenwsewnwneneseenw\neesenwseswswnenwswnwnwsewwnwsene\nsewnenenenesenwsewnenwwwse\nwenwwweseeeweswwwnwwe\nwsweesenenewnwwnwsenewsenwwsesesenwne\nneeswseenwwswnwswswnw\nnenwswwsewswnenenewsenwsenwnesesenew\nenewnwewneswsewnwswenweswnenwsenwsw\nsweneswneswneneenwnewenewwneswswnese\nswwesenesewenwneswnwwneseswwne\nenesenwswwswneneswsenwnewswseenwsese\nwnwnesenesenenwwnenwsewesewsesesew\nnenewswnwewswnenesenwnesewesw\neneswnwswnwsenenwnwnwwseeswneewsenese\nneswnwewnwnwseenwseesewsenwsweewe\nwseweeenwnesenwwwswnew")
(def i "nenwenwneeneswwnewnwswnwneneenwnenene\neseseseswneseenweeeeeenweseewe\nsenwneswenesenewnwswswne\nswseseseseeseseseneseewnwsewsesesenwe\nnwwwswwswseswswseswswsenenwsenww\nnwnwswnenwnwneneseseseswnwnwwsenwnwswenw\neeneeeeswenwneswseeeenwnwneewnene\nnwneneswneneneneenwneneneneswsenenwnwnewe\nsesesesweweswswswseswswesesewseswwne\nnwnwnenwsewswnwnenwnwnwwnwnwnenwnwnwsese\nswswseseswswswswswnwswseswneswswnesene\nnenenenesenenenwneneswneneswnwnenwnwne\neneeneeneeswneneneeeneseeenwnew\neneeseeeeeseeswenesewe\nnenwnenwnwnwenwswswnenwneenenenenenwnw\nwnenwseneneswnwenwnw\nnenweeeweweesesweeeeswneeee\nsesenesesewesesesweeweseneseseee\nenwnwwnwnwnwnwswnwenwnwnwnwwnwnwnwe\nnenwswwewnwswswweswswseswwswwwswsw\nesewnenesenewwswseswesesewneseswse\nseseweseeeeeseese\nneswswswsesesenweswswswswsewnwwneneswse\neeeswnwwswenwenenwenweseeneswe\nnwseneenweesenwseeswenenewswwsew\nseswnwswsesweseseseswswsene\nswnwseseeenwnwenwswswseseeseswseseese\nwnwnenwnewnenwsenwnwnwnewnenwneenese\nsenenwnwswswenwswswwswswse\nwseeseseewseseseseseseeseswseenwnese\nneenwnenenenenwesesw\nwswswwswesweswswwswneswswneswwswsw\nnweseseeseswsesesewesenweese\nnenenenewnenweewenewneneswswnenenwsw\nneeneenenenesenwseneneweneenewnene\neeneeswnwsesweeeeenenweeswse\nwswswswswswswnwswswneswswswwswneseswse\nswwneswswsenwswseswseseswsenenenenenwswe\nneneenenewenewnenewsenesenenenenenenww\nnwseswswswswseswswswswswswse\nneneseeseseswwseesenwnwseseswwnesee\nwswsweswwwnwswwewwswwnwwwsenwwsw\nswnenesenewenenenenw\neneesenewseseneeseseseseseswseseswse\nneeeeeeweeeeseewnweeswee\nwnwenwswnwnwenwenwswsewnwnwnwwnwnwnw\nnwseswswnwseseswenwseneenwenwswseseseswe\nnwwnwenwnwnwnwnwnwnwnw\nnenwneenwswswweweneeswnwneneswenene\nnewwnewswweewwwwseswwewwnw\neseewseseeseeeeesee\nsenwnwseseeseseneneseeeesweeeewesw\nwwwwwwewwwwwwwnwe\nneseneneneneneewneeneneneeeswenenw\nswnwenwnwswnwnwnwnwenwwnwenwnwwnwwnwnw\nseeneeeeeeneeeeenwnene\nseeswnenenweseewsenwnwneeeeenew\neswswwwnewsweneneswwswswwseneswwne\nnwwswnwswenwneenwnwnwnwnwnwnwnwnwnenene\nwswwswwseswwsewwwnewwenewswnew\nswseenwnwnwnwwswnwnenenwnwnw\nswwswwwneseseseeseswweeeewwne\nwwwsewswwenwnwsenwwswseneenwnene\nswswsesweswnwswweneswswswwswswwswsw\nswswswswsesenwswwnenwswseswseswwswswswnesw\neneseewseesweeeeseweseweeee\nnwneseenewneenenee\nseewnweeswnenenwneenenesewnesenewse\nwesenenewwnewseeeswswswswnewwew\nswswnweneswswsewnweesenwsesenwseneww\nnenwswnwnwnwswswnwnwnwnwnwnwnwneswnwnwnee\nnesenwnwnwnewnwwwswnwswenwnwnwnwswnw\nswswneswwswswwwswswswnwswswseswsw\nneneneneseswneneenwnwwneswesenenenene\neeseeeseweswsenwwnesenenwwsesesww\neswesweseewenweeenesenweeene\nnenwewnwnwnwwnwweseswnwenwnwswnwnw\nswnweswnwsweseseswseeseswnwnwseswneswsw\nwseswnwnesewsenwseseswnwseneseswsenwsee\nwswsweswswseswnesweenwweswnwneswswswsw\nneeswsweneswwswswnwswwswneswswswswswsw\nswswnwswwwswswewwswswnwewswwswsew\nwnwnenwnwnwnwnwsesenwnwnwnenw\nesweesewwswnewswwnenesw\nnwnwnenwnwnenesenwnenewseneneneswnwnenw\nnwswneswsweneseswnwneweneseeeseseew\nwwwwnwswwnwwnwnwswewnwwwwne\nnenwneseenenesenwwnwnewwnenwnwnwnenwnwne\nnwnwwsenwenwsenwnwnwenwnwnweswwnwswnwnw\nnwnwwnenwnwnwnwnwnwsesenwnenwnwsenwwnwnwne\nesesweswnwseswswswseswseeswnewwsew\nnwnwesenwsewswsesewsesenweseeseswse\nswwswswswswwswneneswswswwseswwswnew\nneneswwnwneswweneneenweeneswsweswne\nsewseseweseseseneeeeseeseewsesee\nsesesenwnesesesesenewseswsesewne\nwweeeeneesenweseeseeseeesesee\neseewesweeenwnwenwswnewswenee\nnenweeswwenesenesenenwnewswwesw\nnwwwnwnwesewsenwnwnwenwnwwnwnwww\neweneeseseneeswnweeseeewewse\nsesenenenwwweneeeeweneeeeene\nseswsesesesesenwseeseeseesesenwswnwse\nwnwwswswwnewwwwewwwwsewwnenesw\nwneneswenewswswnenenwnenweene\nsenwnwnewseswwsesenwnwnwwwneenenwwwnw\nwwwwwnwwwwswwweewwwwneseww\nwseswnwnwnwnenwwewnwswwenwseewe\nneseswswnweenwnwswseswwnwseswwenesese\nneneswnenenwneswnwnwnenenweneneneenenw\neswnwswswwswswswswswswsesweewnwswsww\newwsewwwwwwnewsewnewnewswww\nwswnwwneswswnwwwswnwwesweseeewnwsw\nneenwnwnenwswwnwnenwnwsenenww\nwwnwnwnwnwwenesewsewwwwwnwnwww\nwnenwsweeeeeesweeeswnwneewee\nswswwswewwwwwnww\nneeseneenewnenenee\nswseeneeeeenweeswswnwswnesweenese\nseweeeeweeeweeeeeneeneee\nneseseenewseswseswsesesesenesenwnwswsese\nnenwnwwwnwwnwwnwsewwwnwsenwnwenwene\nnwwnwnwsenwwnenwsenwnwswne\nwwewswsewwseenenewwwwwswsww\nwseesewwwenwesesesenwseeseswneeee\nwnwnwswnenwwswwneneswnwwwwnwsewnw\nnwsewseneseseseeesenwnwseswseeseneese\nswsenwnwneseswswswswwswnweswswwne\nneneseneneneenenwswswnenwseenenwwnwesw\nneeseweeseeneneneeneeweenenene\nnwnenwnwnenwnwneswnwnwnenwnenenw\nswsenesweswswswwwwweswnwswnwswsww\nseeeseesewswnesesweneeeeesesesenwe\nneeeweeneneeeeeeene\nnwnwnewsesenenewnesewwneswnwwwswsw\nneenwenenwneseneswnesenw\newswneneenwnenenewnweswneneneesee\nswswnewwswwwnwseswswneewswswwswsw\nsewsenweseeeseseseseseseeseenwene\newswwsenewnewswnwwwseseneswnesw\nswswswenwseswwnewwsewnenewwswnwseew\nnwwnwnwnwenweewswnwwnwneswswwsenesw\nnwnwwseewnewnewwnwwweswsenwww\nnenweeeneswneswnwswneneneeswenenwswne\nswwewswswseswwnewnwswswwswnenwswsww\nsenwnwnwwwewwnwsenwwnwnwswnwwnwnw\nwwswwwweewwswwswswwnwwww\nneeswwswswswwwswswswsewsww\nswsenwnwnwnwwwnwneeswwwene\nnewwneeneswsenwewwsenenwnenwswenwsene\nsesesenesesewnwnwnesesesenwnwwsenwsenw\nwnesenwnwnewewswsewewenwwwese\nnenwenwneeneneeneseewneeweesese\nenwneweeeseeeeneeseeesweenwe\nesweweneeweneesew\nsenwnweswwswnewse\nswsesenewnewswswseswsenwseswseseneswse\neeenwnwewnwseseswneswsesweeneswne\nsewwnenwseweneeseneewswneswseesew\nswswwsweswnewweswswweswwsw\nswnwswwseeweenwsenwseswneenweneneene\nswwnwwwswnesewnesenwwenwnwwnwwnesww\nnenewseneneenenenweswenwneeeneene\nnwnwnenwwwnwnwenwewewnenenwnwsenw\nnenwswswswseseswewnwneswswseswseseeneswsw\nswswswswswswswswswwwswnwnewsweswnew\nneswnwenwneswnwnwnenwnwnene\nneswenenenwnenenenenwnwnenenwne\nnweswseswswswswwsweswwswswwneneswsww\nnesenenewwseswwnenwnwnwese\nswneneneeeseeeenwnenwneeeeswsenw\nseseswwswswswswswne\nneneneswsweneneneneneseenewnwe\nnweeesweenweeeeeeeeweeese\nwewseenwswswswsenwswswse\nneeeneneesenenenenwswseewewnenene\nwnwnwnenwnwnwnwnwnenenwe\nnwneneneneneeswnenene\nnwnwnwnesenenenwwnenenwnwnwse\nesweeneeneeee\nswswswswswswswneswswswswswswsw\nneeseneeneneewnwneneseewnesenenene\nnenenesewneneenesenenenenenewnwnene\nwswseswwwwswwwswwwswnesewnewsw\nseneewenwwwwwwwwwwnwwwwnw\nswseswswswswwwneswswswswnwswseswswsw\nwenesweneeneenenwesewse\neseseweseeeswsweseeeseneseenesenw\nwesenenwwnweewsenwwswwwenweswnw\nsesewnwneenewswseseseenwswwswneswsee\nnwnwnwnwswnwseswnenenwnwnwswnwnwnee\nswseswneswswwwswnwswswneswnwswswseswswsw\nswseswseswneneseseseseseenwsesesewww\nsenwswseswnwesenwew\nwswnwswswswseswneswswswswseswsweswsese\nsesesenwenesesesewswswnwseseswseesese\nwneneneeeneneneweneeseseeeweene\nswneswnenwseseneswsewswswsese\nseseswseesesewewseseseswseseseewsw\neneseneseeseeseseswsewsesweenwseeswse\nnwwnwenwwswnwwsenwswwnwnwnwseeswwese\nnwswnwewnwnwnwwww\nnwswswwnwswswsweswseswseswswswwswne\nweswswswswswswswswswswsesw\nneneneenesenenenewnenenenweneseswwnenene\nswseseswswswswseseswswswswsesenwnwsw\nneneneneneeneneneswneeenesenwnenwsenenw\nesewnwnenenwnwnwnwnwnwsenwenenewnwnene\nnenenwneenesewneneswseenwnwswnenenw\nseneesewseseeseeenweneeeeweswnew\nnwnesenwenenwnwnwnwwnw\nswneswswwnweewnwseneeswnwwewene\nswnwswwwswwwwenwnewswswswwswesesw\nnwnwneenenenenenewnenesesenene\nnwwsewsenwnwwnwwwwnwnenwne\neseeesesesenwseseewse\nwnweswseneneeneneneseneneswnewenesw\neeneeeeeeeeenwneeswe\nswneewwenwsenwsewswwnwwnwewswwsw\nsewswnesweneseswwnwwswsenese\nsesewswnwneswwenwswwnwnwewswnesew\nwwnwswswnesewewwwwwwneswsewswsw\neseseseseeseseseeseenwwseseseswnwnesese\nneeenwswnwweneeneeneseneswneeneenee\nwnesesewswseswsweswnwsesewewneneenwsw\nwneenenenwneneneneneswwnesenenenenwswne\nweeseenweeneeeeseswneneneewenwe\nnewneneeneseneenenewneseneeneneww\nneeneswseeeesenweeeeenwseseeew\nseswswseseeseswnwswsesesweswswswswnww\nswswswswseneswnweswswswswwseswswswswswswne\nnewneenwnenenenenenenenenenene\nnenwwwnwnwnwneswneneenwnwnenenwesenwne\nesenenenenenewnweneneneneneneswnwneene\nswnwewswwwswswwwnewwswwnesewew\neeeseeseeeweeseneeeeseenew\nswwwenenwsweseswwseseseswswseew\nneesenwnenwswseee\nneneswswnwenenenenweswsenenenwneswnwese\nneneneeneswneneneseswneewnwnewenesee\nnewseswswneswsenesewswseseenesewsese\nswseewwswwwnwwewwswsweneswsww\nwwnwewnwnwnwnwnwswwnwwwsenwsenwnww\neseswseswnwsewneseseswswswwwswswnwswne\nwnwnwwnwnwwnesewsewnwwewnwsewsww\nseswswnwseswswswswswseneneswswwswseswswsw\nseseseeseseswneneewsewse\nswswsenwswswseswswsewswseseeenesesw\nnweneneeeseseeswswesweeeswnewese\nnenwnwwnwnwsenwwnwnenwseswnwnwwnwnwnw\nswwswswsenwsewwwswswne\nnwsewsesewnenwnewnwnweenewwneee\nneneswnenwenewneneneneneswsewsene\nwswswswswwsenwswseseswswseneswsesesene\nseswswswwenenesweswswseswnwseswswnwsesw\nswnwnewswswnwswswswswwseswswswswswsew\neeeneeeeneneenenweswnene\nwwwwsenewneneswsewswwwwwwnww\nwswwwwwewnwwwwweswnwneseesww\nnenwenenwweswwwwswwswswswswesww\nnwnesweeeesweeeenwewnweeeswsw\newwsenwnwsenwnesenenwwseneesw\nseeneneneneenenenenenenenwne\nsenwswswswswnwswswswswswseswswenenwswse\nneenenweewnwneseeneneseseneeeswee\nnwwswwnwesenwenwwnwnwnwnwswnwseseesw\nweswnwswwswswsenwswswswwsw\nwswswnwswsweeswswswswswweswswsw\nseseenwnwnwesweesweneeeneeeeee\nsewweswnwwswswwswswnwseswenewwwnw\nnweneewenesweweseseeseeweee\nsewseeseseeeseenwsenwseseseenesesw\nenwnwnenwnesewnwnwenwswwnwnwnwwnwwnw\nswsenwnwseeseswnweeweswenwenesee\neswnwnwnenwenwwse\nsewswnenwsenwnwwnwnenwnenwseswwnwsewnw\nwnwswwnenesweswwwwwwwewwwseww\nwnwnwswwnesenwenwswwewnwnwnwwnww\nnwnwseseenwnenenenenenwnewnenw\nsesweseneswwswseswseswsesesesesenwnesesw\nsewsenwswwneseseneeseneenenwswwnwe\nnwwnwnenwwenwewneesewwnwenwnenwnw\nnwwwenwswsenwneseneeenewswswwww\newwnewwwwwswswwwwswww\nsenewwnwwewswwsenenwwwwwsesenw\nsesenewsesweswseswseswnwnwseswswswsenese\nneeseneswnenenwnesenenenenenwwwnenese\nnwsenenwnenenenwnenewneseweswnenenenenese\nswswseseswseswnwweswwseeseseswseswse\nwswwnewwseewwswwwwswswwwneww\nseewnewsesenwenwwenwseseeesweewnw\nnewseswsenwseesewesenewsese\nseswnesenwnwnwnwsesewnwnwsenenenenwnwnew\nnenwnwnenwseesenewswnwneneswnwswenwnwe\nswswswnwseeswweswswswswswsewneswswswse\nswswswswswnwwswswswswweswwwsweswne\nseeseseswwsenwswseneeswseseseswnwsese\nnenenwnenenenewneneneseneenenene\newsewnwwwnwwewwwwsewnwneswnwse\neeeneeeneeeeeenenewne\nseewwsewwwnwsewnenewewnweww\nnwnwneneswsewnwnwnenwsenw\nnwwseseswesewnwnwnenweswnwne\nneswswswswswwneeswseswwneswswse\nswswswswswwswswswneswseeneseswneswwsw\nsenenwseeswnenwnwswewswenwwnwswnwnw\nneneseswneswneswneenwnenwse\nseseseneseweneweeeeseseseseseee\nnwnwwenwnwwwnwseswnwsenwswenesenwsenwnw\neswnwnenwnwnwwenene\nsewseneseenwseseseeeeee\nswnwwnwnwenwnwnwnwswwnwewwwnwnww\nswwneswnwswwswwwneewwwnewwwwse\nnenwseeseswseeseseswwsewsesesesesenw\nswwneswswnwneswsenwsewseseeswneseswese\nsenwswswswwwnweswsewnwseseseneneneswse\nenwseseswnwnwsweeesewnewswwseeesw\nweneneeswseswnewnwseseeswswsewwwne\nenenewswsenwseseseseseswseswseswswsenww\nswswswwswnwwswweswwswwewswww\nenewneeeseenwseneneene\nswseswnwseseseeseswswnesewseseswnwsesesese\nsesesesewewsesewsesesesesesenesesesenese\nnenwenwnwnenwswwnwsenwwnwnwnwenwnwnwnw\nseseswnwnwswswseseeseswsesenenwseswsesesese\nenenweenwseswwesenesewneswwsweenwe\nnenenenwneneneswenenenwne\nnenesesewswswseseswswseswse\nwwwnwnwewwswwwwsenwwsene\nwswwnwenewnwwwsenwswsenewwwwnee\nswnenwnenenwnenenenwnwnene\nneneswswnwnwwnenenenenwnwneneeenenwne\nseneswseswewswnesesesesenwseswsewsesese\nwsewwnwnwnwnwwwwseswnesenwsenwnenwnw\newnwsewnwwnwwsenwnwsenwnwnenwneesenw\nesesesesesesenwseseseesenwseseseswesw\nwswwwnweewwwnewwswnwswswseww\neeenwseeeeseeeswswesewnenese\neseswswswwswnewswseswseseeswwswswnesw\nneseeneneeneeneneenwseneenw\nneneneneeneewnwwneneeswnenenenenenew\nwwwnwwewwwwwwwnwwwewewse\neseeneeenweenesw\nesweseseswseswnwseswswswswneswswneswnw\nswswswneewnesenwesenwwswnenenweee\nneneeenwswnenenwneeneneneeneswnenee\nnesenenwwwweswewwse\nneesenwseseswsesesesenwswsewseseseseseswe\nnwnenenwneseneswnwneseneneneesenenenwne\neseesesesesewseseese\nnwnesenwnenwnwnwnwnwswese\nswseswneswwneswswsese\nsenwwswwswwnewnewswsenwnesewnesee\nwswwnwwnwswwsewewsewww\nnwswnwnesenwwnwnwnewenwwnwnwwwnwnw\nnweesweenwnweswseeeeeenwesenenee\nwnwsewewwwenwwswenwnwwwnwnesw\nswneswesesenenewneswwswswsesenwnwnesee\nswseswswesewswseneswswnwswswseswsesenese\nnwnwnesewnenwnesenenenwsewnenenenewnese\nwewwwswwswwwnwnwwewwwsww\neeenenwswwsesenwsenwneswewseesewswe\nswsenwsesweenwesesesesewnwsenwsesesesw\neenenweneeeneneneneeneneswsewee\nesenwswsewweseswsenwneseseseseesesee\nsesenwswsesenewswsweneeswenwnwsenee\nnwnwenwnwwsenwnwnwseewnwnenwnwnwnwnw\nneswseneswnwnwsenwnenwesenesewnwnwwwswe\neseeeweseeswneseseeeeseee\nnwneneenwnenwnewnwnesenwesenwswwnenenew\nwnesesenwwnewswwwseswnewsewnesewww\nnwnwnwwnwnwenwnwsewnwnenwsenwnwnwnwwnw\nseswseseneswneswnwswswswseswswswswswew\neeneseseenweseseswsesenesewseewse\nenwnwwenenenwsewwwswwnwnwwswnwww\nnwwnwnwnwnwwsenwnenwwnwnwewwwsenw\nsewnenwweeenweseswnwnwsesese\nwnwnwnwwnwswswwsenwnenenenwsenwnwsenw\nsesewsewsesesenesesesenweenwsesesesee\nnwnenwswswwweswewswwswwswswswseswwne\nesewneeseenewewneenwnenenenesew\nneeeswenwwwwwwnwwnwwweeswwse\nwseneswseeewnwwwwne\nnwsesenwseseswesesewseswneeneswswsww\nswswswseswesesewswswswsw\neenenenenewswneneneneeenewenwseee\nswnwseswsenwneeswswswwswswnwswenweenw\nwnwswwwswsweeneswwswswwwswsenwse\nwswnwnwsesweswwwwweswswwswe\nsewsewewwswswswnwnewnwswnewswwsw\nwswseeenenewswswswnwswwneneneseswneene\nswwnewswswswwwwswnwswswswweswwse")


(def opposite
  (let [m {"se" "nw" "e" "w" "sw" "ne"}]
    (merge m (set/map-invert m))))

(defn remove-opposites [line]
  (reduce
    (fn [r next]
      (let [prev (peek r)]
        (if (= next (opposite prev))
          (pop r)
          (conj r next))))
    []
    (re-seq #"se|sw|ne|nw|e|w" line)))

(->> t str/split-lines first (remove-opposites))

(defn next-xy [[x y] dir]
  (let [Y (case dir
            ("w" "e")        y
            ("se" "sw") (inc y)
            ("ne" "nw") (dec y))
        X (case dir
            ("w")       (dec x)
            ("e")       (inc x)
            ("se" "ne") (if (odd? y) x (inc x))
            ("sw" "nw") (if (odd? y) (dec x) x))]
    [X Y]))

(def neighbours
  (memoize (fn [xy] (map #(next-xy xy %) (keys opposite)))))

(neighbours [0 1])


(defn step2 [all-black]
  (let [still-black
        (->> all-black
          (filter #(->> % neighbours (filter all-black) count #{1 2}))
          (into #{}))
        become-black
        (->> all-black
          (mapcat neighbours)
          (remove all-black)
          (filter #(->> % neighbours (filter all-black) count #{2})))]
    (into still-black become-black)))


(let [lines (->> i str/split-lines (map remove-opposites))]
  (->> lines
    (map #(reduce next-xy [0 0] %))
    (reduce #(update %1 %2 not) {})
    (filter #(-> % val true?))
    (map key)
    (set)
    (iterate step2)
    (drop 100)
    (first)
    (count)))

3733