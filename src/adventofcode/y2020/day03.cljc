(ns adventofcode.y2020.day03
  (:require [clojure.string :as str]))


(def test-input "..##.......\n#...#...#..\n.#....#..#.\n..#.#...#.#\n.#...##..#.\n..#.##.....\n.#.#.#....#\n.#........#\n#.##...#...\n#...##....#\n.#..#...#.#")
(def input "...#..............#.#....#..#..\n...#..#..#..............#..#...\n....#.#.......#............#...\n..##.....##.........#........##\n...#...........#...##.#...#.##.\n..#.#...#....#.....#........#..\n....##.###.....#..#.......#....\n.#..##...#.....#......#..#.....\n............##.#...#.#.....#.#.\n..........#....#....#.#...#...#\n..##....#.#.#......#.........#.\n#.#.........#..............##..\n....##.##......................\n....##..#...........#..........\n..#..#.#........##....#......#.\n..............#..#....#.....#..\n.............#...#.....#...#...\n.#...........#..........#...#..\n.#......#.......#......#.......\n#..#.............#..#....##.###\n........#.#...........##.#...#.\n......#..#.....##......#.......\n.....#.....#....#..............\n#...##.#......#......#...#.....\n...........................#...\n...#....................#.....#\n..#.....#...#.....##.....#.....\n....................#......#..#\n.......#.....##......##....#...\n#........##...#.....##..#...#..\n........#..#.#......#..###..#.#\n##.....#.............#.#....#..\n..#.................#....######\n.#.#..#.....#.#..........#.#...\n.........#....#...#............\n........#..#.....#.............\n............#.#.............##.\n...#....#..#......#............\n.##....#.....#...#.#...........\n..#..............#...........##\n.....#.#.##...#................\n..........#..#.#..........##..#\n..#....#...#...#.....######....\n....#.#..#........#....#.###...\n.......................#.......\n..#.....#.##................#..\n.....#......#..#.....#........#\n.#...###.......#.#.........#..#\n............#..................\n..#.........##.........##......\n#...........#.#.......###.#....\n.#...#.....#.........###.....#.\n.#............#........#..#....\n...##.#......##................\n........#...#...#...#..........\n.......#.##......##.#..........\n....##.......#..#....#....#....\n......#.........###........#...\n#....#....####....##......#....\n......................#....#.#.\n...#.#.#....#.#...#...#......#.\n......#.....##.#...........###.\n#........#.........##......#.#.\n....##.....#.....#..#..........\n......#...#...#.........#...##.\n..#........#..................#\n.........#..##.#..#..#...#.#..#\n.....#.....#...#.....###.....##\n.............#....#...#........\n..........#.#.#...#..#...#....#\n#...............##.......#.....\n#...#.............#..#...#....#\n..#...#...##...##...#..#.......\n..#..#........#.#...........#..\n.....#.....#..................#\n....#....##....###..###...##...\n..#......###.........##....#.##\n.......#.##...#.......#..#.....\n...#.#.#.#.....##..#..#........\n................##....#.#......\n..#...#...#...#.....##.#...#..#\n..#..#.....#..##....#....#.....\n.###...#......#........#.....##\n##......#..#........#..........\n....#...#..#....##..#......####\n.#.....##....#..........#......\n.#...#....#.........#...#....#.\n.....#..#.#..#......#..##....#.\n...#.##...#...#........#......#\n.#..#...#.#..#.........#...#...\n#....#......##.....#.......#...\n..##............##..#.#.#...#..\n##.......#.......##............\n#......#.##........#...#...#...\n.#.#.......##.........#..#.#...\n.............##.#........#.....\n.#..#...###...#..#.............\n.....#...#..#....#.......#.....\n#.#.........#.#.#...#...#.#....\n.....#.......#.##.##...#....#..\n.#.##..#.....#...#.#.#.#.#..#..\n..........#...................#\n.....#.#.#...##.........#..#..#\n.#..#....##......#...#.........\n.##......#......#...#........#.\n.....##.#......#............#.#\n.#.....##..#...........##......\n.....#......#.......##....#....\n..#..##..........#.#..........#\n#.#.......##..#..##.#....#.....\n.......#..#.#.......##......#.#\n....#...##...#..............#..\n.....#.........#......#...##...\n#.........#........##..#.....#.\n.#.#..#.....##.......#......#..\n........#..#....#.....###..#...\n#.#..#.#..........#............\n..#......##..#....#.........#..\n#..............................\n.......#............#..#..#.#..\n.#.....#.#....#..#.##.#........\n.......#.###.#........##.#..#..\n..............#....#.....##.#..\n#..............#....#.###......\n.#..#..#...###............#...#\n.#.##...#....#..#...#...#......\n......##..#..#......#..#....#..\n.........#.......##............\n...........##...#..#....####...\n.#..................#..........\n#...#..#..................#....\n..............#.....##.....#...\n..#.#..#...##..#.....#.....#..#\n....#....#.#.........#.....#...\n.#.......#...#....#...#.#..#..#\n#.........##.....##.......#...#\n#..#............#....#........#\n..........##...#......#....#...\n.......#..##...............#...\n#............#.#.#.....#.......\n.#........##...#...............\n..##....#.....#..#.##.#......#.\n.#...#.............#...#.....#.\n...##....#.......#......#.#..#.\n#......................#..#.##.\n...#..........#..#.........#...\n..#......#.......#.#....#......\n....#............#...#......#..\n.....#..#..##...#...#.........#\n.....#......#....#....#........\n.............#..#..........#...\n....#..............#.....#.#...\n....#.................#.#...#.#\n.........#.#...........###.#.##\n#...........#..##.#....#.##.#..\n#.#.....#......................\n##.#.........#....##.#.#..#.#..\n#..........#.#.#.#.#..#..##..#.\n..#...#..###.........#......#..\n.....#......#..#.#............#\n...........#...#.#.#.###....#..\n#....#..#.......##.#.......##..\n..............#.....##.#.......\n.#.....#.#..#.........#.#.#..#.\n..#..#..#..#................#..\n...........#..#.#...#.........#\n.#..#..#...#........#...#.#..#.\n...#.#..#......#..#............\n........#......##.....#....#...\n#...#......##.#.#..............\n.#........................#....\n#.#.....#.##.....#..#.#........\n#..........##.#.......#....#..#\n#...#..#..#.....#....#....#....\n#...........#..#.#....##.##....\n##......#..#........#.......##.\n#........#..#...#..........#...\n...#...#......##....#.#........\n...##..#..#.##....#...#........\n#.#..#....#...#........#.......\n..........#.......#..........#.\n......##...#....###...#....#...\n........#..#.....#......#......\n....#.........##...#..##......#\n....#...........#.#..#.#.#.#..#\n..#......#..#......#........#.#\n#..#....#.....#.............#..\n............................#..\n#...#.#.....#...#....#....#....\n........#...#...#...#...#......\n.###........#....#.##.....##.#.\n.........#.....#..........#....\n.#.........#....##.#.....#.....\n#..#....................##.#...\n..##.#.............#....#.#....\n..#.#........#............##.#.\n#........#...##.....#...#.....#\n.........#.#..........#....#..#\n...###.#..#.#......#.#.....#...\n......#.....#..#...#........#..\n.......#...#.....#....#....#..#\n.#.#........#......##.......#..\n#.................###..........\n#........#.#..#....#..#........\n..##....#.#...##...#...##....#.\n...#.#......##...#.....#..#....\n#..#........#...###....#.......\n##.#....#..#.#..........#......\n....#...###...#.....#........#.\n..#.#........#....##.#.........\n......##.##.................##.\n.#....##...#.#..#.#............\n.#...###........#......#.......\n##..#.#......#..#..#...#.......\n.......##..#....#........#....#\n......#..........#.............\n....##..##..#......#.#.........\n.....#....................##...\n...###.....#.....#...#.#.##.#..\n....#.#..#.......#..#......##..\n.......#.#..#.##.#...#......#..\n...#.#....#.#...#..##...#...#..\n#.##...#....#..#.............#.\n...#...#...#.......#..........#\n.#..#.............#..##.#......\n....#.......#..............#.#.\n..................#..#.....##.#\n.#...#..#......#..........#...#\n..#.#.....#..#....#....#####.#.\n.......###.......#....#....#...\n......#.#........#...#.........\n......#..#.#.#....#.#.#....##..\n.#...#.#...##.#......#.........\n#....#..##....#.#.......#....#.\n..##.#.....#.....#.........#...\n......#......#....#....#.....#.\n...##.....#....#......#......#.\n......#......##............#.#.\n.##.#.......#....#...#....#....\n....#..#..#...##.......#..#....\n....#....#...#.#........#..#...\n....#.....#..........#..#......\n....#....#...#.....#..##.....#.\n##...#..##......#....##..#..#..\n.....##.##..............##.....\n#.#....#.##..#....#...##.......\n..#.....##.....#.....######...#\n...#.....#.#.#......#......##.#\n...........##.............#....\n...##......#..#......#...#.....\n....#.##......#..#....#.#..#...\n.#..#....#...#..#.....##.......\n.....#..#.................#..#.\n................#..#...#......#\n...##....#.....#..#....##......\n....##...............##...#....\n......#..........#..##.........\n.......###.......#.........#..#\n......................#....#.#.\n#.#.....#...##............#....\n........#......##......#.....#.\n...#....#....#.#..##.#..#.#.#..\n..#.#....#.##...#..#.....#.#...\n............#....#..#.......#..\n#...#...#.#......#...##.....#.#\n......#....#....#.......#......\n....#.......#..........#....#..\n........#####........#....#....\n......#....##..............#.#.\n....#....#.......#.......#.....\n.##.#....##....#...............\n#.....##........#..#.#...#.#...\n...#......##....#..............\n.#.....#.....#.......##....##..\n#....#..........#.#..#.........\n......##..........##.......#...\n.##......##.....#.#....#......#\n....#......................#...\n.#...........###........#...#..\n#.#..#..#..#...##.#....#.#..#..\n...##...........#.#..........#.\n......#.#..#....#....#.........\n....#....#.#......#.........##.\n.#..#...#...##....#...#......#.\n#.#......#...#.#.#...........#.\n##.....#..........##....##..##.\n...#.#.....#..##........#......\n..#........##........#..#......\n.......#...............##..#...\n.......#.#....#..###...........\n.............#........#...#....\n#.................#......#..#..\n...#....#..#..............#...#\n.............#....##....#..##..\n#........#..........##...##...#\n............#....#.....#.#....#\n.....#..............##..#...#..\n..#....#......###....#.#...##..\n....##......#.....#....#.......\n.....#...............#.....#...\n.#.....#.....#..............#..\n#................#..#..........\n.##....#....#.....#............\n#.####...#..#..#....#..........\n..##........##.....##......#..#\n......#.....#...##.........##..\n....##..#.....#.#.........#...#\n.....##..#....#....#.#...#..#..\n...#............#...........#..\n.......#.#..#.#.#..#........#.#\n....#.#........#.#.#..#...#...#\n..#....#....#..#......#........\n.#...........................#.\n.#..#....####........##......#.\n.#.....#..#.#.................#\n.#..#...........#...#....#...#.\n......##..#........#..#....#...\n..#.............#....#........#\n#.#..........#.##.......#.#..#.\n..#....#...#...............#...\n..............#..........#..#..\n..#.....#.#.....#...#...#..#...\n.........#...###.#...#........#")


(defn solve [input slopes]
  (let [forest    (->> input str/split-lines (mapv vec))
        width     (->> forest first count)
        height    (->> forest count)
        tree?     #{\#}
        start     [0 0]
        next-xy   (fn f1 [[x y] [dx dy]] [(mod (+ x dx) width) (+ y dy)])
        not-done? (fn f2 [[x y]] (< y height))
        landscape (fn f3 [[x y]] (get-in forest [y x]))
        trees     (fn f4 [slope]
                    (->> start
                      (iterate #(next-xy % slope))
                      (take-while not-done?)
                      (map landscape)
                      (keep tree?)
                      (count)))]
    (->> slopes
      (map trees)
      (reduce * 1))))


(def slopes1 [[3 1]])
(def slopes2 [[1 1] [3 1] [5 1] [7 1] [1 2]])

(assert (= (solve test-input slopes1) 7))
(time (assert (= (solve test-input slopes2) 336)))

(assert (= (solve input slopes1) 191))
(time (assert (= (solve input slopes2) 1478615040)))