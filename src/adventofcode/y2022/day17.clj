(ns adventofcode.y2022.day17
  (:require
   [com.akovantsev.blet.core :refer [blet blet!]]
   [adventofcode.utils :as u]
   [clojure.string :as str]))

(def sample ">>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>")
(def input "><<<<>>>><<<><<<><<<>><<>>><>><>><<<<>><<<<>><<<>>>><<<><<<>>>><<<<><<><<>><<>>>><<<>>><<<>>>><<>><>><<<<>>><<<>>>><<<<><<>>><<<>>><<>>><>>>><>><>>>><<<>>><<<>><>>><<<<>>><>>>><<<>>>><<<<>><<>>>><<>><>>><<>>><>>>><<<>><<>>><<>>><<<<>>>><>>><>><<<<>>><<<>>><<<<>>>><<<>>><<<>><><<<<>>><<<<><<<>>><<><>>><<<<>>>><>><<<>><<>>><<<<>><<<>>><<>>>><>>>><>>><>>>><<<><<<<>><<>><>>><<>>>><<<<>>>><>>>><>><<<<>>>><<<<>>><<>>><<><>><<<<>><><<<<>>><<<>>><<<>>><<<>><<>>>><<<><<<>>><><<>>>><<<><>>>><<>>><>><<<>>><<<<><<<>><<<>><>>><<<<>>><<>>>><>><<<>>>><<<<>>>><<<>><<<>>>><<>><<>>>><<>>><<<<>>><>>>><>><<<>><<<>>><<<<>>>><<<>>>><>>><>>><>>><><<<>><<<>>><<<<>>>><<<>>>><<>>><<<<>><>><<>>>><>><<>><<<<>>><<<>><<><<<<>><<<<>><<<<><<>><>>><<<><<<><<<<>><<<>>><<>>><>>><<<<>><<><>><<>>><><<<<>>>><<>>>><<<<>>><>><<<<>><<>>>><<<>>>><<<>>>><<><<<<>>>><<<><<<<><<<>>>><<>>><<><>>>><<<>>>><<<<>>>><<<><<<>><<>>>><>>>><>><<<><>>>><<<>>>><<<<>><<<><<<<>>>><<>><>>><<<>>><>><>>>><<<<>>>><<<><<<>><<>>><<<>>><>>><><>>><<>><<>>><<<<>><<><<<>><><<><<>><>>>><<>>>><<<<>>><>>>><>>><<<>>><<<>>>><<><>>><<<>>><>>>><>>>><><<>>>><<<>>><<<>><<>>>><>>>><<><>>>><<<><<<>>>><<<<>>>><<>>><<<<>><<<>><><<<>>>><>>><><><<<><<>><<>>>><<<><<><<<>>>><<<<>>><<><<>>><<<>>>><>>>><<<<>><>><<><<<>><<<>>><<<<>>>><<><<<<>>>><>><<<>>>><<<<><<<<>>>><<>><<>><<><<>>>><<>>><<><<>>>><<>>>><<>>>><<<<><<<<><<<<><<<>>><<<<>>>><>>>><<<>>><<>>><<<>>>><>>><<>>>><<<>><<>>><<><>><<<>><<><<>>>><<>><<<<>><<<>>>><<<>>><<>>><<>>><<>>>><<<<>><>>><>>><><<<><>>><<<>>><><<>>>><<><<<<>><<<<>>><<<<>>><<<<>>><<<>>><<<<>>>><<<<>>><<>>><<<<>><>>>><>>><>><<<><<<><<>><<><<<<><<<<>><<<<><>><<<>>>><<<<>>>><>>><<<>>><>>><<>><<><<>>>><<>><<<<>>><<<>>>><<>>><<>><<<><<<<>>>><<>><>>>><<<<><>>><<>>><>>><<<>>><>><<>><<>>>><<<<><<>><<<<>>>><<<<>>><<<<><>>>><>>><<><>>><<<<>>>><>><<<><><>><><><<<<>><<<<>>><<<><<<<>><>>>><<<><<<<>>><<>>><>>><<<>>><<<<>><><<<>>><<>>>><><<<<><<><<><<<>>><>><>>><<<>><<<<>>>><<<>><<<<><<<<>>><<<<><<>>>><<<>><>><<<>>><<<<>><>>><<<<>><<<<>>><<<<>>>><<>><<<>><<>>><<>>>><>><<><<<>>><<<<><<>><<<<>>><<<>>>><<>><<><>><<<>>><>><<<<>>><<<<><<>><<<>>><<>>>><<<>>>><<<<>><<<<><<<<>>>><<<<>>>><<><<<<>>>><>>>><<<<>>><<<<>><<>><<<<>>><<<<>>>><<>><<>><<<<><<<<>>><<<><<<>><>>>><>>>><<>><<<<>>>><>>>><<<>>>><<<>>><<<<><<<>>>><<>>>><<><<<<>><><<<>>><<<><>><<<<><<<>>>><>><<>>><<<>>>><<>>><<<>><<>>>><<<<>>>><<<<>>><<>>>><<<<>>><<<<>><<>>><<<><>>><<>>><>><<><>>><<<><<>>><<<>>><<<>><<>>><>><>><><<<<>>><<<>><<<<>>>><<<<>><>>><<<<><>>><><<<<>>><<<>>>><>>><<<>><>><<<>>>><<<<><<<>>><<><<>>><<<>>>><><<<>>><<>><<<><<<<>><>>><<><<>>><<<<>><<<<>><<<<><<><>>><><<>>>><<>>>><<<<>>><<<>><<<><<<<>>>><<>>><<<>>><>>><<<><>>>><<<><<<<>>>><>><>><<<>>>><<<>><<>><<>>><<<<>><<<<>>>><<<<>>>><<><>>>><<<<>>>><<<<>><<<<><<<<>>><<<<>><<<>>>><>><<<><<<<>>><<>>>><<<>><<<>>><>>><<<><><<><<>>><>>><<<>><<<>>>><<<<>>>><<<<>><<<>>><<<>><<>><>>>><<<<>><<<>>>><<<>><<<>>>><>>>><>>><<<<><>>><>>><<>><><<<>>>><<<<>>>><<>><<>>><><>><<<<>><<<>><<<>>>><<<>><<<>>><<>>><<<>>>><<><<<<>><>>><<<>>><<><<<<>><<<<>>><<<<>>>><<<><<<<>>><<<<>>>><<<>>><><<>>>><>>>><<<<>>><<<>>><<<<><<<>><<<><<<>><<<>>>><<<<>>>><<>>><<>><<>>>><<<>><><<<>>>><><<<>>>><<><<>>><>>><<<<>><<<<>>>><<<<><<<>>>><<>><<<>><<<>><<<<>><>>>><<<<><<<<>>>><><<>><<>><<<<>><<<<>>>><<<<>>><<><<><<>>>><>>>><<><<<>>><<>>><<>><>><<<><<>>>><<<>>><>>>><>>><<><<><<><>><>>>><>><>><<>><<<>><<>><<<<>>><<<<>>><><<<>>>><><<>><>>><>><<<><<>><<><><<<>>>><<<<>>>><<<<><>>>><<<<>>><<>>>><<<>><<<<>><<>>>><<<<>>>><<>>><<<<>><<<>>><<<<>><<>><<<>>>><>>>><<<<><<<<>>><<<<>><<<<>>>><<<>><<<<>>><>><><<<<><<><<<>><<><<<>>><<<>>><<><<>>><<>>>><<<<>><>>>><<><<>>><<>>>><<><<<<>><>><>><<>><<<>>>><<<<>>>><<<><<<<>>>><<<<>>>><<>><<>>>><<<>>>><>>><<<><<<>>>><<>>><<<<>>>><<<<><<>><<>>><<>><<<>>>><>><>><<<><<<>>><<<><>>>><>>><><<<<>><<<>>>><<<<>><<>><<<>>>><>>>><<>>><<<<>>><<<>>>><<<<>><<<<>>>><<<<>><<<><<>>><<>>><><<<><<<>><<>>>><>><<<>><<>><<<<>>><<><<<>>><<>>>><<<<><<>>>><><>>>><<>>><<<<><<<<>><<<><<<><<><<<>>><<<<><<<>><><<<<>>>><<<<>>>><<<>><<<>>><<<><<><><<>>>><>>><<<<>>>><<<<>>><<>>><<<<><<<<>>><<<><<<<>><<><<><<<>><<>><<>>><<>>><<>>><>>><<<>>>><<<<>>><>>><<<>><<><<>>>><<<<>>>><<<>>>><<<>>><<><<><<<><<<><>>>><><<<<><<<>>>><>>><>>>><>><<>><<<<>>>><<>>><>><>><>>><<<<>>><>><<<<>>>><<<<><<>><>>>><>>><<>>>><<<>>>><<>><<<<><<<>><><<<<>>>><>>>><>>><<<>>>><>>>><<<<>>>><<<>>>><<><<><<>>><<><<>><>>>><<<>>><<<>>><<<>>><><<<<>>><>><<<<><<>>><<>><<<<><<<<>><<>><<>><<>>>><<<>>>><>>><<<>>>><<<>><<<<>>><>><<>>><><<>>><<<>>><>><<>><<<<>><<<>>>><<<<>><<>><<<<>>>><<<>>>><<<<><<<<>><<<<>><<<<>>>><<>><<<<>>>><<<<>>>><>>>><>>><>>><<<<><<<>><<>>>><><<>>><>>>><<<<>>>><>><>>>><>>>><<<><<<>>><<>>>><<<<><>>><<>><<<>>>><<>>>><<>><<<><<<>>><<<><<><<>>><>><>>><<>>>><<<>><<>>><<<>>>><<>><><<>><<<<>>><<<>><<<>>><>><<>>><<<<>>>><<>><<>><<<<>>>><<>>><>>>><>><<>><<>>>><<<>>>><<<>>><<>>>><<><<><<<><<>>>><<>>>><<><>>><<><<<>>>><><<>><<<>><<<>>>><<>><<<<>>>><>><<<>><>>><<<>>><<<>>>><<<<>>><<<>><<<<>>><><<<<>>>><<><<>><<<<><<><<>>>><>><>><>>><<<>>>><<<<><<<>><<>>>><><<<><<>>><<<<><<<<>>>><<<>>>><<<>><<<>><<<><<><<><><<<<>>>><<<<><<<>><<<<><<<<><<<<>>>><<<>><<<>>>><<<<>><>><<>><>>>><>><<>><<><<<><<<>><<<>>><<<<>>><<<>>>><>>><<<><><<<<>>><<<<>><<<<>>>><>>><<<<>>>><<>>>><<<<><<>>>><<<<><<>>><<<>>><<<><<<<>>>><<<<>><<<<>><<<<><<<>>><<<<><<<<>><<<>><<<<>><<>>>><><<>>><>>><<<>><<><<><<>><<><><<>>>><><>>><<<>><>>><<<>>><<<>><<<<>>><<>>><<>>>><<>>><<<<>><<<<><>>>><>>>><<<<>>><<<>><><><<>>>><<><<<>>>><<>><<<><><<<<><<<><<<>><<<<>>><<<<>><<<<>><<<<>>>><<<<>>>><><>>>><<>>><<><<<>>><<<><>>>><<<<>>>><>><<<>><<>><<>>>><<<<><>>><<<<>><<><<>><<<<>>><><<<><<<><<<>>><<>><<<<>>>><<<>>>><<<<><>>>><><>><<<>>><<<<>>>><<<>>>><<>><<><<>><<<<>>><<<<>><<>>>><<>><<<<>>>><<<>>>><<<<>>><<>><<<<><><<>><>>><<><<<>><<<>><<<>>>><<>><<<<>>><<<>>>><>>><<<><<<<>>>><<<<>>><<<>><<<>>><><<<<>>><<>>>><<<>>><>><><>><<<><<<<><<<<>>>><<<>>><><<<><<<>><<>><<><<><>><><<<>><<<<>><<>>>><<<<>>>><><<<<><<<>>>><>>><<<>>>><<<>><>>>><<<>><<<<>>><<<<>><<>><><<<<>><<>>><<<<>><<<>>>><<><>>>><<<<>>>><><>>><<>>>><>><<>>>><><>><<>>><><>>><<<>>>><<<<>>><<<><<<<>>>><<<>><<<<>><<<>><>><<<>>><<<<>><<>>><>><<<<>>>><<<>><<>><>>><<<<>>>><><<><<<>>><<<<>><<<<>><><>>><<>><>>>><<<<>>>><<<>>><<<>><<<<>>>><<<>><<>>><<<>>><>>><<<><<<<>>>><<><<<<><<<>>>><>>>><<<>><>>>><><<<<>><<<<>>>><<<>>><>>>><>><<<>>>><<><<<>>><<><<<>>>><<>><<>>><<<>>>><<<<>><>>><<<<><<<<>>>><>><<<>>><<><>><<<>><>>><<<>>><<<<>>>><<<>>>><>>><<><<<<>>>><><<<>>>><<>>><><<<>>><<<<>><<<>>><<>>><<<><<><<<>><<>><<<<>>><<<><><>><<>>><<<<>>><>>>><<><<<<>>>><<<<><<<>>><<<>><<>>>><>>>><<<><<>>><<<>>>><<><<<>>><><<<<>><<<<><<<<>><<>><<<<>>>><<<>><<<<><<<<>>><<>>><<<>>><<<<><<<<>>><<<<>>>><<<>>><<><<<<>>><<<<>>><><<<>>><<><<<>><>>><<<<>>>><<<<>>><<>><<<<>><<<><<<<><<>>>><<<<>>>><<>>>><<<<>>><<<>>>><<>>><<>>><<<<><<<<>>>><><<<>>><<<>>><><<<<>>><<>>>><<<<>>><<<>><<>>>><<<<>><<>><<<<>><<<<>>>><<<><>>>><<<><<<<>><>>><>><<<<>>><>>>><>><>><<<<>>>><<<<><>>><<<<>><>><><><<>><<<>><<<><>>><<<<><<<>><<<<>><<<<>>><<>>>><<><<<<>><<<>>><<<>><>><>>>><<<<>>><<>><<>><<>>>><<<<>>>><<<<><<>><>><>>>><<<>>><<<<>><<>>>><<>>><>>>><<>>>><<<<>>>><<<<>>><<>><<<>>><<>>>><<>>>><<<><<<>>>><<<<>>>><<<><<><<>>>><>>><<>><<>><<<>>>><<<><<>>><<><<<>>>><<<>>><>>><<<>><<<>><>>><<<<>><<<>>>><<><<>>><>>><>><<>><<<>>>><<>><<<<><><<<><<>>>><<>><<<>>>><<<><<<<><<><<<<>>>><<<<>><<><>>><<<><><<<<>><<>><<<<><>><<><<<>><<<>>>><>><>>><<<><><<<>><<<>><>>><>><<<<>><<<>>><<<>>>><>><>>>><<>><<<>>><<>>><<><<>><<>><><<<>>><<<>><<<<>><<<>>><<<<>><<<>>><<<>>><<<<><<<<>>><>><<<<>>><<<>>>><<<>><<>>><<>>><>>><<><<<><<<<><<>>>><<<><<>>><>>>><<<>>>><>>>><<><<<>>><>>><<>>><<>>>><>>>><>>><<>><<<>>><<<>><>><>>>><<<><>>><>><>>><>>><<<>>>><<>>>><<<>>><<<<>><>><><<>>>><>><<><<<<><><><<>>>><<<<>>><>>><<<>>>><<<>>><>>><<<>><<<>>><<<<>><<>><<<<>>><<<>><<<<>>><<<<>><>><>>>><>>><>><<<<>><<<<><>>><>><>>><<<<>>>><<<><<>>><<>>>><<<<>><<<<><>><>><<>>><<>><<><>><><<>>>><<<<>>>><<<<>>>><<>>><<<<><>>>><<<<>>><<<>><<>>>><>>><<<>>><<>>>><<<>><<<><<<<>>>><<<>>>><<<<>><<<><<<<>>>><><><><>>><<<>><<<>><<<>>><<>><<<<>><<<<>>><<<>><<<<>><>><<<>><<<>>>><<<>>>><<>><<<<>>><<>>>><<>><<>>>><<<<>>>><<<>>><<>>>><<<>>>><<><<<<><<>><<<>><<<>><<><<<>><><>>><<>>><<><>>><<<<>>>><<<>>><<>>>><<<>>>><<<>>>><<<<>><<<<>><<>><>>><<>><<><<<>>><<<>><<><<>><<><<<<>>><>>><<><<<>>>><<>>>><>>><<>>><<><><<<<>>><<><<<>><<<><<>>><<<<>>>><<>>>><><>>><<<>>>><<<>><<<<><<<<><<<<>>><><<<>><<<<>>><<<<><<<>>><<<>><<<<>><<<<>>>><<<<><>><<<>>><<<<><<><<<<><<<<>>><<>>><>>>><<<>>><>>><<>><>><<<<><<<<>>>><<<>>><<<><<>>>><<><<<<>><<>>>><<<>><<<<><<<<>>><>><><<<>>>><<<<>><>>>><>>><<<<>>>><<>><<>><>>><<><<><>>>><<<<>>><<<>><>>><<<><>>><<<<>><<<<>>>><>>><>>><>>>><>><<>>><<<<>><>>><<><<<>>><<>>>><>>>><<>>><<<<>>><<><<<><<<><<<<>>>><<<>>>><<<>>><<<<>>>><<<<>>>><<>><<<<>>><<>>><><<>><<><>>><<>>><>>>><<<>>>><<<<>>><<<><<<<><>>><<><>>>><<<<>>>><<<>>><>>>><<<<>>><<<>>>><<>>><<<><<>>>><<>>>><<<<><>>>><<>>><<<<><<<><>>>><<<<>>><<<>><>><<>><>>><>>><<<>><<><>><<<<>><<<<><<<<>>><<<>>>><<<<>>>><>>>><<<<>><<<<><<<<>>>><<<<>>><<<>>>><>>><<>>>><<<>><>>>><<<<>>>><<<>><<>>>><<<>>>><<<><<>>>><<<<>>>><<<<>><<<<>>>><>>><<>>><<<>>>><<<>>><<<>><>><<>><>>><<>><<<>><<<><<<<>><<<<>>><<<<>>>><<<<>>><<<>><<<<><<<><<<><<<>>><<>><>><>>><<>>><<<<><<<<>><>>><>>><<<><<<<>>><>>>><<>><<<<>>>><<>>><<<><><>>>><<>>>><><>>>><<><<<<>><<<<>><<<>><>>><<>>><<<<>>>><<<<>><<<<><<><>>>><<<>><<>><<<>>>><><<<><<<>>><>>>><<>>><<<<>>>><><>><>>><<<<>><<><>>>><<<>><<<<><<<>>><>>><<><<<>>><<<<>><<<>><<<>>><>>>><<<>>>><<<>>>><<<>>><<<<>><<<<>><<<<>><<<<>>>><<<>><>><>><<>>>><>>>><><<<<>><<><<>><>><>>>><<>>>><<>>><<>>>><<>><<<>><<<<>>>><<<<><>>><<<<><<><<<><<<>><><<<>>>><<>>><<<>>>><>>><<<<>>><<<>>><<<>>><>>><<<<>><<>>>><><>>><<>>>><<>>><<>>><><<<>>><<<<><<<>>>><<<><<<<>><>>><<<>>><>>><<><<><<>>>><<>>><<<><<><<>>>><<<>><<>><<<<>><>>>><>><>><><>><><<>>>><>><<<>>>><<><<<>><<<<>><<><<<<><<><>>><<>>><<>><<<>>>><<<<>>>><<<<>>>><<<<>><<<<><<<>>><<<><<>><><<>>>><<><>><>>>><>>>><<>>><<><<<>>>><<<<>>>><>>>><>><<<<>>>><>>>><<<>><<>><<<<><<>>>><<<>>>><>>>><<>>>><>><><<<<>>>><<<><<>><<<<>>>><<<>>>><<<<><<<>><>>>><<<<>><<<><<<<>>><<<>><<>>>><<<<>><<<><<>><<<>")

(def W 7)
(defn wall? [[x y]] (or (= x 0) (= x 8)))

;floor y = 0, grows up
(def FLOOR #{[1 0] [2 0] [3 0] [4 0] [5 0] [6 0] [7 0]})


(def MINUS [[3 0] [4 0] [5 0] [6 0]])

(def PLUS [,,,,, [4 2],,,,,,
           [3 1] [4 1] [5 1]
           ,,,,, [4 0],,,,,,])

(def ANGLE [,,,,,,,,,,, [5 2]
            ,,,,,,,,,,, [5 1]
            [3 0] [4 0] [5 0]])

(def STICK [[3 3]
            [3 2]
            [3 1]
            [3 0]])

(def CUBE  [[3 1] [4 1]
            [3 0] [4 0]])

(def FIGURES [MINUS PLUS ANGLE STICK CUBE])

(defn update-xs [xys f & args] (map #(apply update % 0 f args) xys))
(defn update-ys [xys f & args] (map #(apply update % 1 f args) xys))

(defn topmost [xys] (->> xys (map second) (reduce max)))

(defn step [DB]
  (let [{:keys [::xys ::maxy ::jets ::figures]} DB
        figures- (rest figures)
        figure   (first figures)
        start    (update-ys figure + 4 maxy)

        sideways (fn [figure jet]
                   (let [f       (case jet \> inc \< dec)
                         shifted (update-xs figure f)]
                     (if (or (some wall? shifted)
                             (some xys shifted))
                       figure
                       shifted)))

        downward (fn [figure]
                   (let [shifted (update-ys figure dec)]
                     (when (not-any? xys shifted)
                       shifted)))]

    (loop [jets   jets
           figure start]
      (blet [jets- (rest jets)
             jet   (first jets)
             side  (sideways figure jet)
             down  (downward side)
             xys+  (into xys side)
             db+   {::jets    jets-
                    ::figures figures-
                    ::xys     xys+
                    ::maxy    (topmost xys+)}]
        (if (nil? down)
          db+
          (recur jets- down))))))

(defn steps [ss]
  (->> {::xys     (set FLOOR)
        ::maxy    (topmost FLOOR)
        ::jets    (cycle ss)
        ::figures (cycle FIGURES)}
    (iterate step)))

(defn p1 [ss]
  (->> ss steps (drop 2022) (first) ::maxy))

#_(time (assert (= 3068 (p1 sample))))
#_(time (assert (= 3102 (p1 input))))
"Elapsed time: 2389.776527 msecs"
"Elapsed time: 2282.679467 msecs"
;
;(->> sample steps (take 10000) (map ::maxy) (partition 2 1)
;  (map (partial apply -)) (map -) (str/join))
;
;(def head "1212002322103401332213042133000112013320133000032213240003401230103022022201321213200123201320012300133001212213240130421322002210133401212200320133401330013022")
;(def segment "132221302003300132121332202212103100330013020123000222003011130221232213212123201224002322130301230101210133021230012130132021220202130023400032012122030300132013302133200220212240133000230013220003201330202122103101213003242130000130202020133401302213030032001301013300123421031213340003201330013320133201334010340132001230213300133221330013030122201332012222132121320203030002401330012300132201230212240133000030013320132201322213002133201304012220123401304013322130111220013300020301324013320121201321203002133020030200320133000030013030132011213213222133021322013022003201330012202132201332013220013220234203300133221302013202132021332012222130011332210340132201330012300132111330012322103121320013001132221031201322133200230003300130200302013322133001334213242130421324213302132001122002200133001303002032122201232012322023201302013220133001332213020121200220012340133001222213322123000324013342022111212013200133421212012242132111322012122130110302013302122100211013302022401320011240123201332013240132001330012301132011300202342103221330013201021110321113320121201320013302123421332013012132221330013300133221322013340123021302212222001301332013302130320234013302112221332012300123020221203240123021230103300123401330013220133001330013320123201232202302123011221113030033001330002300132201330213320133201334003320023201334013212133021322001320130220032213022133221332013212133021320213020130301322200222123021304013022133021332013220133401232013200033220001012320003021214013020132201214213300133021321213202133021332002020121401302213300133001303002220132201320013200132201330002220023001322013020133021234013222003121332213320133001330013320133401230113040133201322001220133001332002130")
;(count head)
;(count segment)

;13340123011322002340121201212013200
;
;(count "132121322013202")
;(def sample-str "132121322013202133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230113220023401212012120132001334012301132200234012120121201320013340123011322002340121201212013200133401230")
;sample-str
;;; grow head until no matches,
;;; drop head,
;;; grow segment until next idx = segment len
;;; calc
;
;(defonce input-str
;  (->> input steps (take 3000) (map ::maxy) (partition 2 1)
;    (map (partial apply -)) (map -) (str/join)))
;
;input-str


(def LEN 1000000000000)


(defn p2 [ss]
  (let [full-str   (->> ss steps (take 3000) (map ::maxy) (partition 2 1)
                     (map (fn [[a b]] (- b a)))
                     str/join)
        sample-len 20 ;; with sample-size = 10 am getting false positive
        sum-str    #(->> % (map str) (map read-string) (reduce + 0))]
    (loop [head-len 0]
      (blet! [head-len+    (inc head-len)
              seg-str      (subs full-str head-len (+ head-len sample-len))
              next-idx     (str/index-of full-str seg-str head-len+)
              still-head   (nil? next-idx)
              seg-len      (- next-idx head-len)
              full-seg-str (subs full-str head-len (+ head-len seg-len))
              head-str     (subs full-str 0 head-len)
              tail-len     (- LEN head-len)
              n-segs       (quot tail-len seg-len)
              rem-len      (rem tail-len seg-len)
              rem-str      (subs full-seg-str 0 rem-len)
              head-score   (sum-str head-str)
              seg-score    (sum-str full-seg-str)
              rem-score    (sum-str rem-str)
              score        (+ head-score (* n-segs seg-score) rem-score)]
        (if still-head
          (recur head-len+)
          score)))))

not 1510559006206

(assert (= 1514285714288 (p2 sample)))
(assert (= 1539823008825 (p2 input)))

